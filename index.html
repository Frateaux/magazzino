<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carico Merci Enterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --carico: #10b981;
            --scarico: #f43f5e;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f8fafc;
            color: #1e293b;
        }

        .card {
            @apply bg-white rounded-3xl shadow-sm border border-slate-200 p-6 transition-all duration-300;
        }

        .btn {
            @apply px-6 py-4 rounded-2xl font-bold transition-all flex items-center justify-center gap-3 active:scale-95 disabled:opacity-50;
        }

        .btn-carico {
            @apply bg-emerald-500 text-white hover:bg-emerald-600 shadow-lg shadow-emerald-100;
        }

        .btn-scarico {
            @apply bg-rose-500 text-white hover:bg-rose-600 shadow-lg shadow-rose-100;
        }

        .btn-ghost {
            @apply text-slate-500 hover:bg-slate-100;
        }

        .input {
            @apply px-5 py-4 rounded-2xl border border-slate-200 focus:outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 w-full transition-all text-lg;
        }

        #reader {
            width: 100%;
            border-radius: 1.5rem;
            overflow: hidden;
            border: none !important;
        }

        .modal-overlay {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }

        /* Focus state for big buttons */
        .big-action-card {
            @apply flex-1 flex flex-col items-center justify-center p-8 gap-4 rounded-[2.5rem] border-4 transition-all;
        }
    </style>
</head>

<body>
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Status Bar -->
        <div
            :class="['py-2 text-center text-[10px] font-black tracking-[0.2em] uppercase text-white transition-all duration-700', isOnline ? 'bg-indigo-600' : 'bg-rose-500']">
            <span v-if="isOnline">● Sincronizzato Cloud</span>
            <span v-else>○ Solo Locale (Offline)</span>
        </div>

        <main class="flex-1 p-4 md:p-8 max-w-xl mx-auto w-full pb-24">

            <!-- VIEW: DASHBOARD -->
            <div v-if="currentView === 'dashboard'" class="space-y-10 pt-4">
                <header class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-black text-slate-900">Magazzino</h1>
                        <p class="text-slate-500 font-bold text-sm">Enterprise Edition</p>
                    </div>
                    <button @click="currentView = 'inventory'"
                        class="w-14 h-14 bg-white rounded-2xl shadow-sm border border-slate-200 flex items-center justify-center text-indigo-600">
                        <i data-lucide="package" class="w-6 h-6"></i>
                    </button>
                </header>

                <!-- MAIN ACTIONS -->
                <div class="flex gap-4">
                    <button @click="startSession('carico')"
                        class="big-action-card border-emerald-100 bg-emerald-50 text-emerald-700 hover:border-emerald-500 hover:bg-emerald-100">
                        <div
                            class="w-16 h-16 bg-emerald-500 text-white rounded-3xl flex items-center justify-center shadow-lg shadow-emerald-200">
                            <i data-lucide="plus-square" class="w-8 h-8"></i>
                        </div>
                        <span class="text-sm font-black uppercase tracking-widest">Carico</span>
                    </button>

                    <button @click="startSession('scarico')"
                        class="big-action-card border-rose-100 bg-rose-50 text-rose-700 hover:border-rose-500 hover:bg-rose-100">
                        <div
                            class="w-16 h-16 bg-rose-500 text-white rounded-3xl flex items-center justify-center shadow-lg shadow-rose-200">
                            <i data-lucide="minus-square" class="w-8 h-8"></i>
                        </div>
                        <span class="text-sm font-black uppercase tracking-widest">Scarico</span>
                    </button>
                </div>

                <!-- SESSIONS LIST -->
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <h2 class="text-sm font-black text-slate-400 uppercase tracking-[0.15em]">Attività Recenti</h2>
                        <span v-if="dirtyCount > 0"
                            class="text-[10px] bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full font-bold animate-pulse">
                            Syncing {{ dirtyCount }} items...
                        </span>
                    </div>

                    <div class="space-y-3">
                        <div v-for="session in sortedSessions" :key="session.id" @click="openSession(session.id)"
                            class="card group relative flex items-center gap-4 cursor-pointer active:scale-95 p-5">
                            <div
                                :class="['w-12 h-12 rounded-2xl flex items-center justify-center shrink-0', session.type === 'carico' ? 'bg-emerald-50 text-emerald-500' : 'bg-rose-50 text-rose-500']">
                                <i :data-lucide="session.type === 'carico' ? 'download' : 'upload'" class="w-5 h-5"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-black text-slate-800 break-words line-clamp-1 capitalize">{{
                                    session.name }}</h3>
                                <p class="text-[10px] font-bold text-slate-400 uppercase">{{
                                    formatDateShort(session.createdAt) }} • {{ session.items.length }} Movimenti</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span v-if="session.status === 'open'"
                                    class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                            </div>
                        </div>
                        <div v-if="!sessions.length" class="py-16 text-center text-slate-300 font-bold italic">Nessuna
                            attività registrata</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: SESSION DETAIL -->
            <div v-if="currentView === 'session'" class="space-y-6 pt-4">
                <nav class="flex items-center justify-between">
                    <button @click="closeScannerAndBack"
                        class="p-3 bg-white rounded-2xl shadow-sm transform transition-all active:scale-90">
                        <i data-lucide="arrow-left" class="w-5 h-5 text-slate-500"></i>
                    </button>
                    <div class="flex gap-2">
                        <button v-if="activeSession.status === 'closed'" @click="exportPdf('session')"
                            class="w-12 h-12 bg-white rounded-2xl shadow-sm border border-slate-200 flex items-center justify-center text-rose-500">
                            <i data-lucide="file-text" class="w-5 h-5"></i>
                        </button>
                        <div
                            :class="['px-4 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest flex items-center gap-2', activeSession.type === 'carico' ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600']">
                            <i :data-lucide="activeSession.type === 'carico' ? 'plus-circle' : 'minus-circle'"
                                class="w-3.5 h-3.5"></i>
                            {{ activeSession.type }}
                        </div>
                    </div>
                </nav>

                <div class="card bg-slate-900 border-none text-white relative overflow-hidden p-8">
                    <div class="relative z-10">
                        <p class="text-white/40 text-[10px] font-black uppercase tracking-widest mb-1">{{
                            formatDate(activeSession.createdAt) }}</p>
                        <h1 class="text-3xl font-black">{{ activeSession.name }}</h1>
                    </div>
                    <div class="absolute right-[-10%] top-[-10%] w-32 h-32 bg-white/5 rounded-full blur-3xl"></div>
                </div>

                <!-- Input Zone -->
                <template v-if="activeSession.status === 'open'">
                    <div v-show="showScanner" class="card p-2 bg-slate-900 ring-8 ring-slate-100 overflow-hidden">
                        <div id="reader"></div>
                        <button @click="stopScanner"
                            class="w-full py-5 text-sm font-black uppercase tracking-widest text-white/50 hover:text-white transition-colors">Chiudi
                            Scanner</button>
                    </div>

                    <div class="space-y-4">
                        <div class="flex gap-3">
                            <button @click="toggleScanner"
                                class="w-16 h-16 bg-slate-900 text-white rounded-2xl flex items-center justify-center shadow-xl active:scale-90 shrink-0">
                                <i data-lucide="scan" class="w-6 h-6"></i>
                            </button>
                            <input v-model="newItemBarcode" @keyup.enter="handleBarcodeEntry" type="text"
                                placeholder="Scansiona o digita codice..." class="input shadow-sm">
                        </div>

                        <!-- Manual Entry (Quantity only visible if barcode exists or is known) -->
                        <div v-if="newItemRegistered" class="flex gap-3 animate-in fade-in slide-in-from-top-4">
                            <input v-model.number="newItemQty" ref="qtyInput" type="number" placeholder="Qtà"
                                class="input w-32 shrink-0">
                            <button @click="addItem"
                                :class="['btn flex-1', activeSession.type === 'carico' ? 'btn-carico' : 'btn-scarico']">
                                <i data-lucide="plus-circle"></i> Registra {{ newItemTypeLabel }}
                            </button>
                        </div>
                    </div>
                </template>

                <!-- Moves List -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between mt-8">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Elenco Movimenti</h3>
                        <button v-if="activeSession.status === 'open' && activeSession.items.length"
                            @click="closeActiveSession"
                            class="text-[10px] font-black uppercase tracking-widest text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-xl">
                            Finalizza Sessione
                        </button>
                    </div>

                    <div class="space-y-3">
                        <div v-for="(item, idx) in sortedItems" :key="idx"
                            class="card p-4 flex items-center gap-4 hover:border-slate-300">
                            <div class="flex-1">
                                <h4 class="font-black text-slate-800 capitalize leading-tight">{{ item.productName }}
                                </h4>
                                <p class="text-[10px] font-bold text-slate-400 mt-0.5">
                                    {{ item.barcode }} • {{ item.unitsPerBox }} PZ/CONF
                                </p>
                            </div>
                            <div class="text-right">
                                <p
                                    :class="['text-xl font-black font-mono', activeSession.type === 'carico' ? 'text-emerald-600' : 'text-rose-600']">
                                    {{ item.quantity }}
                                </p>
                                <button v-if="activeSession.status === 'open'" @click="removeItem(idx)"
                                    class="text-[10px] font-bold text-rose-300 hover:text-rose-500 uppercase mt-1">Rimuovi</button>
                            </div>
                        </div>
                        <div v-if="!activeSession.items.length"
                            class="py-12 text-center text-slate-400 italic font-medium">Nessun movimento.</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: INVENTORY -->
            <div v-if="currentView === 'inventory'" class="space-y-8 pt-4">
                <div class="flex items-center justify-between">
                    <button @click="currentView = 'dashboard'" class="p-3 bg-white rounded-2xl shadow-sm">
                        <i data-lucide="arrow-left" class="w-5 h-5 text-slate-500"></i>
                    </button>
                    <button @click="exportPdf('inventory')" class="btn btn-ghost py-2 text-xs font-black uppercase">
                        Export PDF
                    </button>
                </div>

                <div>
                    <h1 class="text-3xl font-black text-slate-900">Giacenza</h1>
                    <p class="text-slate-500 font-bold text-sm">Stato attuale magazzino</p>
                </div>

                <div class="relative">
                    <input v-model="searchQuery" type="text" placeholder="Cerca prodotto..."
                        class="input pl-14 shadow-xl shadow-slate-200/50">
                    <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"
                        width="22"></i>
                </div>

                <div class="space-y-3">
                    <div v-for="item in filteredInventory" :key="item.barcode"
                        class="card flex items-center gap-4 transition-transform active:scale-95">
                        <div class="flex-1">
                            <h4 class="font-black text-slate-800 capitalize text-lg leading-none">{{ item.name }}</h4>
                            <p class="text-[10px] font-bold text-slate-400 uppercase mt-2">{{ item.barcode }} • {{
                                item.unitsPerBox }} per confezione</p>
                        </div>
                        <div class="text-right">
                            <p
                                :class="['text-2xl font-black font-mono', item.quantity >= 0 ? 'text-indigo-600' : 'text-rose-600']">
                                {{ item.quantity }}
                            </p>
                        </div>
                    </div>
                    <div v-if="!filteredInventory.length" class="py-20 text-center text-slate-300 font-black italic">
                        Magazzino vuoto</div>
                </div>
            </div>

            <!-- MODAL: NEW PRODUCT REGISTRATION -->
            <div v-if="showRegistryModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div class="modal-overlay absolute inset-0" @click="cancelRegistry"></div>
                <div
                    class="bg-white rounded-[2.5rem] w-full max-w-sm relative z-10 p-8 shadow-2xl animate-in zoom-in-95 duration-200">
                    <div class="text-center space-y-2 mb-8">
                        <div
                            class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-3xl flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="package-plus" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-xl font-black text-slate-900">Nuovo Prodotto</h3>
                        <p class="text-slate-400 text-xs font-bold uppercase">Codice: {{ newItemBarcode }}</p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label
                                class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 mb-1 block">Nome
                                Prodotto</label>
                            <input v-model="regName" type="text" placeholder="Nome Articolo..."
                                class="input !py-3 !text-base" ref="regNameInput">
                        </div>
                        <div>
                            <label
                                class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 mb-1 block">Unità
                                per Confezione</label>
                            <input v-model.number="regUnits" type="number" placeholder="Es. 12"
                                class="input !py-3 !text-base">
                        </div>

                        <div class="pt-4 flex gap-3">
                            <button @click="cancelRegistry"
                                class="flex-1 py-4 font-black uppercase text-xs text-slate-400">Annulla</button>
                            <button @click="saveRegistry"
                                class="flex-[2] btn bg-indigo-600 text-white text-xs uppercase">Salva e
                                Continua</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, Timestamp, onSnapshot, query, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = { apiKey: "YOUR_API_KEY_HERE", projectId: "YOUR_PROJECT_ID_HERE" };
        let db = null;
        try { if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") db = getFirestore(initializeApp(firebaseConfig)); } catch (e) { }

        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const currentView = ref('dashboard');
                const isOnline = ref(navigator.onLine);
                const sessions = ref([]);
                const productRegistry = ref({}); // barcode -> { name, unitsPerBox }
                const activeSessionId = ref(null);

                // Form States
                const newSessionName = ref('');
                const newItemBarcode = ref('');
                const newItemQty = ref(null);
                const searchQuery = ref('');
                const itemInput = ref(null);
                const qtyInput = ref(null);

                // Registry Modal State
                const showRegistryModal = ref(false);
                const regName = ref('');
                const regUnits = ref(1);

                // Scanner State
                const showScanner = ref(false);
                let scannerInstance = null;

                // Load Data
                onMounted(() => {
                    const savedSessions = localStorage.getItem('cm_enterprise_sessions');
                    const savedRegistry = localStorage.getItem('cm_enterprise_registry');
                    if (savedSessions) sessions.value = JSON.parse(savedSessions);
                    if (savedRegistry) productRegistry.value = JSON.parse(savedRegistry);

                    window.addEventListener('online', () => { isOnline.value = true; syncAll(); });
                    window.addEventListener('offline', () => isOnline.value = false);

                    // Real-time Cloud Registry Listener
                    if (db) {
                        onSnapshot(collection(db, "registry"), (snap) => {
                            snap.forEach(doc => { productRegistry.value[doc.id] = doc.data(); });
                            localStorage.setItem('cm_enterprise_registry', JSON.stringify(productRegistry.value));
                        });
                    }

                    nextTick(() => lucide.createIcons());
                });

                // Persist & Sync
                watch([sessions, productRegistry], () => {
                    localStorage.setItem('cm_enterprise_sessions', JSON.stringify(sessions.value));
                    localStorage.setItem('cm_enterprise_registry', JSON.stringify(productRegistry.value));
                    if (isOnline.value) syncAll();
                    setTimeout(() => lucide.createIcons(), 50);
                }, { deep: true });

                watch(currentView, (v) => {
                    if (v !== 'session') stopScanner();
                    setTimeout(() => lucide.createIcons(), 50);
                });

                // Computed
                const sortedSessions = computed(() => [...sessions.value].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)));
                const activeSession = computed(() => sessions.value.find(s => s.id === activeSessionId.value) || { items: [] });
                const sortedItems = computed(() => [...activeSession.value.items].reverse());
                const dirtyCount = computed(() => sessions.value.filter(s => s.unsynced).length);
                const newItemRegistered = computed(() => !!productRegistry.value[newItemBarcode.value]);
                const newItemTypeLabel = computed(() => activeSession.value.type === 'carico' ? 'Carico' : 'Scarico');

                const inventory = computed(() => {
                    const map = new Map();
                    sessions.value.filter(s => s.status === 'closed').forEach(sess => {
                        sess.items.forEach(item => {
                            const b = item.barcode;
                            const prod = productRegistry.value[b] || { name: 'Sconosciuto', unitsPerBox: 1 };
                            const curr = map.get(b) || { barcode: b, name: prod.name, unitsPerBox: prod.unitsPerBox, quantity: 0 };
                            const impact = item.quantity * prod.unitsPerBox;
                            curr.quantity += sess.type === 'carico' ? impact : -impact;
                            map.set(b, curr);
                        });
                    });
                    return Array.from(map.values()).sort((a, b) => b.quantity - a.quantity);
                });

                const filteredInventory = computed(() => {
                    if (!searchQuery.value) return inventory.value;
                    const q = searchQuery.value.toLowerCase();
                    return inventory.value.filter(i => i.name.toLowerCase().includes(q) || i.barcode.includes(q));
                });

                // Actions
                const startSession = (type) => {
                    const name = prompt(`Nome della sessione di ${type.toUpperCase()}:`, `${type.toUpperCase()} ${new Date().toLocaleDateString()}`);
                    if (!name) return;
                    const id = crypto.randomUUID();
                    sessions.value.push({
                        id, type, name,
                        createdAt: new Date().toISOString(),
                        status: 'open',
                        items: [],
                        unsynced: true
                    });
                    openSession(id);
                };

                const openSession = (id) => {
                    activeSessionId.value = id;
                    currentView.value = 'session';
                };

                const handleBarcodeEntry = () => {
                    if (!newItemBarcode.value) return;
                    if (newItemRegistered.value) {
                        nextTick(() => qtyInput.value?.focus());
                    } else {
                        showRegistry();
                    }
                };

                const showRegistry = () => {
                    regName.value = '';
                    regUnits.value = 1;
                    showRegistryModal.value = true;
                    nextTick(() => document.querySelector('input[ref="regNameInput"]')?.focus());
                };

                const saveRegistry = () => {
                    if (!regName.value) return;
                    productRegistry.value[newItemBarcode.value] = {
                        name: regName.value.trim(),
                        unitsPerBox: parseInt(regUnits.value) || 1,
                        updatedAt: new Date().toISOString()
                    };
                    showRegistryModal.value = false;
                    nextTick(() => qtyInput.value?.focus());
                };

                const cancelRegistry = () => {
                    showRegistryModal.value = false;
                    newItemBarcode.value = '';
                };

                const addItem = () => {
                    if (!newItemBarcode.value || !newItemQty.value) return;
                    const meta = productRegistry.value[newItemBarcode.value];
                    if (!meta) return showRegistry();

                    const session = sessions.value.find(s => s.id === activeSessionId.value);
                    if (session && session.status === 'open') {
                        session.items.push({
                            barcode: newItemBarcode.value,
                            productName: meta.name,
                            unitsPerBox: meta.unitsPerBox,
                            quantity: parseInt(newItemQty.value),
                            at: new Date().toISOString()
                        });
                        session.unsynced = true;
                        newItemBarcode.value = '';
                        newItemQty.value = null;
                        nextTick(() => document.querySelector('input[placeholder*="codice"]')?.focus());
                    }
                };

                const removeItem = (idx) => {
                    const session = sessions.value.find(s => s.id === activeSessionId.value);
                    if (session) { session.items.splice(activeSession.value.items.length - 1 - idx, 1); session.unsynced = true; }
                };

                const closeActiveSession = () => {
                    if (!confirm("Finalizzare l'operazione? Non sarà più modificabile.")) return;
                    const sess = sessions.value.find(s => s.id === activeSessionId.value);
                    if (sess) { sess.status = 'closed'; sess.closedAt = new Date().toISOString(); sess.unsynced = true; currentView.value = 'dashboard'; }
                };

                const closeScannerAndBack = () => { stopScanner(); currentView.value = 'dashboard'; };

                // Scanner
                const toggleScanner = () => {
                    if (showScanner.value) return stopScanner();
                    showScanner.value = true;
                    nextTick(() => {
                        scannerInstance = new Html5Qrcode("reader");
                        scannerInstance.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (txt) => {
                            newItemBarcode.value = txt;
                            stopScanner();
                            handleBarcodeEntry();
                        }, () => { });
                    });
                };

                const stopScanner = () => {
                    if (scannerInstance) { scannerInstance.stop().then(() => { showScanner.value = false; scannerInstance = null; }).catch(() => { showScanner.value = false; scannerInstance = null; }); }
                    else showScanner.value = false;
                };

                // PDF & Helpers
                const exportPdf = (type) => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.setFontSize(22); doc.text(type === 'inventory' ? "Report Giacenza" : `Sessione: ${activeSession.value.name}`, 15, 20);

                    const rows = type === 'inventory' ?
                        filteredInventory.value.map(i => [i.barcode, i.name, i.quantity]) :
                        activeSession.value.items.map(i => [i.barcode, i.productName, i.quantity, i.quantity * i.unitsPerBox]);

                    doc.autoTable({
                        startY: 30,
                        head: type === 'inventory' ? [['Barcode', 'Prodotto', 'Qta Tot (Pezzi)']] : [['Barcode', 'Prodotto', 'Conf.', 'Tot Pezzi']],
                        body: rows,
                    });
                    doc.save(`Report_${new Date().toISOString().slice(0, 10)}.pdf`);
                };

                const formatDate = (iso) => iso ? new Date(iso).toLocaleString('it-IT') : '';
                const formatDateShort = (iso) => iso ? new Date(iso).toLocaleDateString('it-IT') : '';

                const syncAll = async () => {
                    if (!db || !isOnline.value) return;

                    // Sync Registry
                    const regDirty = Object.keys(productRegistry.value);
                    const b = writeBatch(db);
                    regDirty.forEach(id => { b.set(doc(db, "registry", id), productRegistry.value[id], { merge: true }); });
                    await b.commit();

                    // Sync Sessions
                    const dirty = sessions.value.filter(s => s.unsynced);
                    for (const s of dirty) {
                        try {
                            await setDoc(doc(db, "sessions", s.id), { ...s, unsynced: false, syncedAt: Timestamp.now() }, { merge: true });
                            s.unsynced = false;
                        } catch (e) { }
                    }
                };

                return {
                    currentView, isOnline, newSessionName, newItemBarcode, newItemQty, searchQuery, itemInput, qtyInput, showScanner,
                    showRegistryModal, regName, regUnits, dirtyCount, newItemRegistered, newItemTypeLabel,
                    sortedSessions, activeSession, sortedItems, filteredInventory,
                    startSession, openSession, handleBarcodeEntry, saveRegistry, cancelRegistry, addItem, removeItem, closeActiveSession,
                    formatDate, formatDateShort, closeScannerAndBack, toggleScanner, stopScanner, exportPdf
                };
            }
        }).mount('#app');
    </script>
</body>

</html>
