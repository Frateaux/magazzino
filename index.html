<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carico Merci Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f8fafc;
            color: #1e293b;
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .card {
            @apply bg-white rounded-2xl shadow-sm border border-slate-200 p-6 transition-all duration-300;
        }

        .card:hover {
            @apply shadow-md border-indigo-200;
        }

        .btn {
            @apply px-5 py-3 rounded-xl font-semibold transition-all flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50;
        }

        .btn-primary {
            @apply bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-100;
        }

        .btn-secondary {
            @apply bg-slate-100 text-slate-700 hover:bg-slate-200;
        }

        .btn-danger {
            @apply bg-rose-50 text-rose-600 hover:bg-rose-100;
        }

        .input {
            @apply px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 w-full transition-all;
        }

        /* Custom Toggle */
        .mode-toggle {
            @apply flex bg-slate-100 p-1 rounded-xl w-full;
        }

        .mode-btn {
            @apply flex-1 py-2 text-sm font-bold rounded-lg transition-all;
        }

        .mode-btn.active.carico {
            @apply bg-emerald-500 text-white shadow-sm;
        }

        .mode-btn.active.scarico {
            @apply bg-rose-500 text-white shadow-sm;
        }

        #reader {
            width: 100%;
            border-radius: 1rem;
            overflow: hidden;
            border: none !important;
        }

        #reader__dashboard_section_csr button {
            @apply btn btn-secondary text-xs p-2 mb-2;
        }
    </style>
</head>

<body>
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Status Bar -->
        <div
            :class="['py-2.5 text-center text-xs font-bold tracking-wider uppercase text-white transition-all duration-500', isOnline ? 'bg-indigo-600' : 'bg-rose-500']">
            <span v-if="isOnline" class="flex items-center justify-center gap-2">
                <i data-lucide="zap" class="w-3.5 h-3.5"></i> Sistema Sincronizzato
            </span>
            <span v-else class="flex items-center justify-center gap-2">
                <i data-lucide="wifi-off" class="w-3.5 h-3.5"></i> ModalitÃ  Magazzino (Offline)
            </span>
        </div>

        <main class="flex-1 p-4 md:p-8 max-w-2xl mx-auto w-full pb-24">

            <!-- VIEW: DASHBOARD -->
            <div v-if="currentView === 'dashboard'" class="space-y-8">
                <header class="flex justify-between items-end mb-2">
                    <div>
                        <p class="text-slate-500 text-sm font-medium">Benvenuto in</p>
                        <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">Gestione Merci</h1>
                    </div>
                    <button @click="currentView = 'inventory'"
                        class="p-3 bg-white rounded-xl shadow-sm border border-slate-200 text-indigo-600 hover:text-indigo-700">
                        <i data-lucide="package"></i>
                    </button>
                </header>

                <!-- New Session -->
                <div class="space-y-3">
                    <label class="text-sm font-bold text-slate-700 ml-1">Inizia un nuovo carico/scarico</label>
                    <div class="flex gap-3">
                        <input v-model="newSessionName" @keyup.enter="createSession" type="text"
                            placeholder="Es: Carico Arrivi Pom." class="input shadow-sm">
                        <button @click="createSession" class="btn btn-primary px-6">
                            <i data-lucide="plus"></i>
                        </button>
                    </div>
                </div>

                <!-- Session Sections -->
                <div class="space-y-6">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <span class="w-5 h-5 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center">
                            <i data-lucide="layout-list" class="w-3 h-3"></i>
                        </span>
                        Sessioni Aperte
                    </h2>
                    <div v-if="openSessions.length" class="grid gap-4">
                        <div v-for="session in openSessions" :key="session.id" @click="openSession(session.id)"
                            class="card group relative cursor-pointer active:scale-95">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-slate-900 group-hover:text-indigo-600 transition-colors">
                                        {{ session.name }}</h3>
                                    <p class="text-xs text-slate-500 mt-0.5">{{ session.items.length }} movimenti
                                        registrati</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span v-if="session.unsynced"
                                        class="w-2 h-2 rounded-full bg-amber-400 animate-pulse"></span>
                                    <i data-lucide="chevron-right"
                                        class="text-slate-300 group-hover:text-indigo-500 transition-colors"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-else
                        class="py-12 text-center bg-slate-100/50 rounded-3xl border-2 border-dashed border-slate-200 text-slate-400">
                        <p class="text-sm font-medium">Nessuna sessione attiva.<br>Crea una per iniziare.</p>
                    </div>

                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2 pt-4">
                        <i data-lucide="history" class="w-5 h-5 text-slate-400"></i>
                        Storico Chiuso
                    </h2>
                    <div class="bg-white rounded-2xl border border-slate-200 divide-y divide-slate-100 overflow-hidden">
                        <div v-for="session in closedSessions" :key="session.id"
                            class="p-4 flex justify-between items-center hover:bg-slate-50">
                            <div>
                                <h4 class="font-semibold text-slate-800">{{ session.name }}</h4>
                                <p class="text-[10px] text-slate-400 font-medium uppercase mt-0.5">
                                    {{ formatDate(session.closedAt) }} â€¢ {{ session.items.length }} ARTICOLI
                                </p>
                            </div>
                            <button @click="openSession(session.id)"
                                class="btn btn-secondary py-1.5 px-3 text-xs">Vedi</button>
                        </div>
                        <div v-if="!closedSessions.length" class="p-8 text-center text-slate-400 text-sm">Nessuna
                            sessione chiusa</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: SESSION DETAIL -->
            <div v-if="currentView === 'session'" class="space-y-6">
                <nav class="flex items-center justify-between">
                    <button @click="closeScannerAndBack"
                        class="p-2 -ml-2 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all">
                        <i data-lucide="arrow-left"></i>
                    </button>
                    <div class="flex gap-2 items-center">
                        <button v-if="activeSession.status === 'closed'" @click="exportPdf('session')"
                            class="btn btn-danger py-2">
                            <i data-lucide="file-text"></i> PDF
                        </button>
                        <span
                            :class="['px-4 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider', activeSession.status === 'open' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600']">
                            {{ activeSession.status === 'open' ? 'Aperta' : 'Archiviata' }}
                        </span>
                    </div>
                </nav>

                <div
                    class="bg-indigo-900 text-white p-8 rounded-3xl shadow-xl shadow-indigo-100 relative overflow-hidden">
                    <div class="relative z-10">
                        <h1 class="text-2xl font-bold mb-1">{{ activeSession.name }}</h1>
                        <p class="text-white/60 text-xs font-medium uppercase tracking-widest">{{
                            formatDate(activeSession.createdAt) }}</p>
                    </div>
                    <i data-lucide="layers"
                        class="absolute right-[-20px] bottom-[-20px] w-48 h-48 text-white/10 rotate-12"></i>
                </div>

                <!-- Scanner & Form (Only if Open) -->
                <template v-if="activeSession.status === 'open'">
                    <div v-show="showScanner" class="card p-2 bg-slate-900 overflow-hidden ring-4 ring-slate-100">
                        <div id="reader"></div>
                        <button @click="stopScanner"
                            class="w-full py-4 text-white font-bold bg-rose-600 hover:bg-rose-700 transition-colors">Interrompi
                            Scansione</button>
                    </div>

                    <div class="card space-y-5 border-indigo-100 bg-indigo-50/30">
                        <!-- Mode Toggle: Carico / Scarico -->
                        <div class="mode-toggle">
                            <button @click="newItemType = 'carico'"
                                :class="['mode-btn', newItemType === 'carico' ? 'active carico' : 'text-slate-500']">
                                <i data-lucide="arrow-down-left" class="inline w-4 h-4 mr-1"></i> Carico
                            </button>
                            <button @click="newItemType = 'scarico'"
                                :class="['mode-btn', newItemType === 'scarico' ? 'active scarico' : 'text-slate-500']">
                                <i data-lucide="arrow-up-right" class="inline w-4 h-4 mr-1"></i> Scarico
                            </button>
                        </div>

                        <div class="flex gap-2">
                            <button @click="toggleScanner"
                                class="btn bg-slate-800 text-white hover:bg-slate-900 shrink-0 shadow-lg">
                                <i data-lucide="camera"></i>
                            </button>
                            <input v-model="newItemName" ref="itemInput" type="text" placeholder="Codice o Nome..."
                                class="input bg-white">
                        </div>
                        <div class="flex gap-2">
                            <input v-model.number="newItemQty" type="number" placeholder="QuantitÃ "
                                class="input bg-white shrink-0 w-32" @keyup.enter="addItem">
                            <button @click="addItem" class="btn btn-primary w-full shadow-lg shadow-indigo-200">
                                <i data-lucide="plus-circle"></i> Aggiungi Registrazione
                            </button>
                        </div>
                    </div>
                </template>

                <!-- Moves List -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between px-1">
                        <h3 class="font-bold text-slate-800 text-lg">Movimenti ({{ activeSession.items.length }})</h3>
                        <button v-if="activeSession.status === 'open' && activeSession.items.length > 0"
                            @click="closeActiveSession"
                            class="text-xs font-bold text-emerald-600 hover:text-emerald-700 bg-emerald-50 px-3 py-1.5 rounded-lg border border-emerald-100">
                            Chiudi Sessione ðŸ”’
                        </button>
                    </div>

                    <div class="space-y-3">
                        <div v-for="(item, idx) in sortedItems" :key="idx"
                            class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                            <div
                                :class="['w-10 h-10 rounded-xl flex items-center justify-center shrink-0', item.type === 'carico' ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600']">
                                <i :data-lucide="item.type === 'carico' ? 'arrow-down-left' : 'arrow-up-right'"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-bold text-slate-900 line-clamp-1 capitalize">{{ item.name }}</p>
                                <p class="text-[10px] text-slate-500 font-bold uppercase">{{ item.type }}</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <span
                                    :class="['font-mono font-bold text-lg', item.type === 'carico' ? 'text-emerald-700' : 'text-rose-700']">
                                    {{ item.type === 'carico' ? '+' : '-' }}{{ item.quantity }}
                                </span>
                                <button v-if="activeSession.status === 'open'" @click="removeItem(idx)"
                                    class="p-2 text-slate-300 hover:text-rose-500">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        <div v-if="!activeSession.items.length" class="py-12 text-center text-slate-400 italic text-sm">
                            Nessun movimento registrato.</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: INVENTORY -->
            <div v-if="currentView === 'inventory'" class="space-y-6">
                <div class="flex items-center justify-between">
                    <button @click="currentView = 'dashboard'" class="p-2 text-slate-500 hover:bg-slate-100 rounded-xl">
                        <i data-lucide="arrow-left"></i>
                    </button>
                    <button @click="exportPdf('inventory')" class="btn btn-secondary text-sm py-2">
                        <i data-lucide="download" class="w-4 h-4"></i> Report PDF
                    </button>
                </div>

                <div class="space-y-1">
                    <h1 class="text-2xl font-extrabold text-slate-900">Giacenza Magazzino</h1>
                    <p class="text-slate-500 text-sm">Calcolo netto da tutte le sessioni chiuse</p>
                </div>

                <div class="relative group">
                    <input v-model="searchQuery" type="text" placeholder="Nome prodotto..."
                        class="input pl-11 bg-white shadow-sm ring-4 ring-slate-100">
                    <i data-lucide="search"
                        class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"
                        width="18"></i>
                </div>

                <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-xl shadow-slate-100">
                    <div class="max-h-[60vh] overflow-y-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 sticky top-0 z-10">
                                <tr>
                                    <th class="p-5 font-bold text-slate-400 text-[11px] uppercase tracking-wider">
                                        Prodotto</th>
                                    <th
                                        class="p-5 font-bold text-slate-400 text-[11px] uppercase tracking-wider text-right">
                                        Netto</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <tr v-for="item in filteredInventory" :key="item.name" class="hover:bg-slate-50/50">
                                    <td class="p-5">
                                        <p class="font-bold text-slate-800 capitalize">{{ item.name }}</p>
                                        <div class="flex gap-2 mt-1">
                                            <span
                                                class="text-[9px] font-bold text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded uppercase">C:
                                                {{ item.carico }}</span>
                                            <span
                                                class="text-[9px] font-bold text-rose-600 bg-rose-50 px-1.5 py-0.5 rounded uppercase">S:
                                                {{ item.scarico }}</span>
                                        </div>
                                    </td>
                                    <td class="p-5 text-right">
                                        <span
                                            :class="['text-xl font-black font-mono', item.quantity >= 0 ? 'text-indigo-600' : 'text-rose-600']">
                                            {{ item.quantity }}
                                        </span>
                                    </td>
                                </tr>
                                <tr v-if="!filteredInventory.length">
                                    <td colspan="2" class="p-12 text-center text-slate-400 font-medium">Nessun dato
                                        disponibile</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURE FIREBASE HERE
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            projectId: "YOUR_PROJECT_ID_HERE"
        };

        let db = null;
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
            }
        } catch (e) {
            console.error("Firebase init failed", e);
        }

        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const currentView = ref('dashboard');
                const isOnline = ref(navigator.onLine);
                const sessions = ref([]);
                const activeSessionId = ref(null);
                const newSessionName = ref('');

                const newItemName = ref('');
                const newItemQty = ref('');
                const newItemType = ref('carico');
                const searchQuery = ref('');
                const itemInput = ref(null);

                const showScanner = ref(false);
                let scannerInstance = null;

                onMounted(() => {
                    const saved = localStorage.getItem('cm_pro_sessions');
                    if (saved) {
                        try { sessions.value = JSON.parse(saved); } catch (e) { }
                    }
                    window.addEventListener('online', () => { isOnline.value = true; syncData(); });
                    window.addEventListener('offline', () => isOnline.value = false);
                    nextTick(() => lucide.createIcons());
                });

                watch(sessions, (newVal) => {
                    localStorage.setItem('cm_pro_sessions', JSON.stringify(newVal));
                    if (isOnline.value) syncData();
                    setTimeout(() => lucide.createIcons(), 100);
                }, { deep: true });

                watch(currentView, (v) => {
                    if (v !== 'session') stopScanner();
                    setTimeout(() => lucide.createIcons(), 50);
                });

                // Helpers
                const activeSession = computed(() => sessions.value.find(s => s.id === activeSessionId.value) || { items: [] });
                const sortedItems = computed(() => [...activeSession.value.items].reverse());

                const inventory = computed(() => {
                    const map = new Map();
                    sessions.value.filter(s => s.status === 'closed').forEach(sess => {
                        sess.items.forEach(item => {
                            const k = item.name.toLowerCase().trim();
                            const curr = map.get(k) || { name: item.name, quantity: 0, carico: 0, scarico: 0 };
                            if (item.type === 'carico') {
                                curr.quantity += item.quantity;
                                curr.carico += item.quantity;
                            } else {
                                curr.quantity -= item.quantity;
                                curr.scarico += item.quantity;
                            }
                            map.set(k, curr);
                        });
                    });
                    return Array.from(map.values()).sort((a, b) => b.quantity - a.quantity);
                });

                const filteredInventory = computed(() => {
                    if (!searchQuery.value) return inventory.value;
                    return inventory.value.filter(i => i.name.toLowerCase().includes(searchQuery.value.toLowerCase()));
                });

                // Session Logic
                const createSession = () => {
                    if (!newSessionName.value.trim()) return;
                    const id = crypto.randomUUID();
                    sessions.value.push({
                        id,
                        name: newSessionName.value.trim(),
                        createdAt: new Date().toISOString(),
                        status: 'open',
                        items: [],
                        unsynced: true
                    });
                    newSessionName.value = '';
                    openSession(id);
                };

                const openSession = (id) => {
                    activeSessionId.value = id;
                    currentView.value = 'session';
                };

                const addItem = () => {
                    if (!newItemName.value || !newItemQty.value) return;
                    const session = sessions.value.find(s => s.id === activeSessionId.value);
                    if (session && session.status === 'open') {
                        session.items.push({
                            name: newItemName.value.trim(),
                            quantity: parseInt(newItemQty.value),
                            type: newItemType.value,
                            at: new Date().toISOString()
                        });
                        session.unsynced = true;
                        newItemName.value = '';
                        newItemQty.value = '';
                        nextTick(() => itemInput.value?.focus());
                    }
                };

                const removeItem = (idx) => {
                    const session = sessions.value.find(s => s.id === activeSessionId.value);
                    if (session) {
                        session.items.splice(idx, 1);
                        session.unsynced = true;
                    }
                };

                const closeActiveSession = () => {
                    if (!confirm("Chiudere la sessione permanente?")) return;
                    const session = sessions.value.find(s => s.id === activeSessionId.value);
                    if (session) {
                        session.status = 'closed';
                        session.closedAt = new Date().toISOString();
                        session.unsynced = true;
                        currentView.value = 'dashboard';
                    }
                };

                const closeScannerAndBack = () => {
                    stopScanner();
                    currentView.value = 'dashboard';
                };

                // Scanner (BACK CAMERA ONLY)
                const toggleScanner = () => {
                    if (showScanner.value) return stopScanner();
                    showScanner.value = true;
                    nextTick(() => {
                        // Use Environment facing mode for back camera
                        scannerInstance = new Html5Qrcode("reader");
                        const config = { fps: 15, qrbox: { width: 250, height: 150 } };
                        scannerInstance.start({ facingMode: "environment" }, config, (decoded) => {
                            newItemName.value = decoded;
                            stopScanner();
                            nextTick(() => itemInput.value?.focus());
                        }, (err) => { });
                    });
                };

                const stopScanner = () => {
                    if (scannerInstance) {
                        scannerInstance.stop().then(() => {
                            showScanner.value = false;
                            scannerInstance = null;
                        }).catch(() => {
                            showScanner.value = false;
                            scannerInstance = null;
                        });
                    } else {
                        showScanner.value = false;
                    }
                };

                // PDF
                const exportPdf = (type) => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.setFont("helvetica", "bold");

                    if (type === 'inventory') {
                        doc.setFontSize(20);
                        doc.text("Report Giacenza Magazzino", 15, 20);
                        doc.setFontSize(10);
                        doc.setFont("helvetica", "normal");
                        doc.text(`Data estrazione: ${new Date().toLocaleString()}`, 15, 28);

                        const rows = inventory.value.map(i => [i.name, i.carico, i.scarico, i.quantity]);
                        doc.autoTable({
                            startY: 35,
                            head: [['Prodotto', 'Carico (+)', 'Scarico (-)', 'Tot. Netto']],
                            body: rows,
                            headStyles: { fillColor: [99, 102, 241] }
                        });
                    } else {
                        const s = activeSession.value;
                        doc.setFontSize(20);
                        doc.text(`Report Sessione: ${s.name}`, 15, 20);
                        doc.setFontSize(10);
                        doc.setFont("helvetica", "normal");
                        doc.text(`Creato il: ${new Date(s.createdAt).toLocaleString()} | Chiuso il: ${new Date(s.closedAt).toLocaleString()}`, 15, 28);

                        const rows = s.items.map(i => [i.name, i.type.toUpperCase(), i.quantity]);
                        doc.autoTable({
                            startY: 35,
                            head: [['Prodotto', 'Operazione', 'QuantitÃ ']],
                            body: rows,
                            headStyles: { fillColor: [79, 70, 229] }
                        });
                    }
                    doc.save(`Report_${new Date().toISOString().slice(0, 10)}.pdf`);
                };

                const formatDate = (iso) => iso ? new Date(iso).toLocaleString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';

                const syncData = async () => {
                    if (!db || !isOnline.value) return;
                    const dirty = sessions.value.filter(s => s.unsynced);
                    for (const s of dirty) {
                        try {
                            const ref = doc(getFirestore(), "sessions", s.id);
                            await setDoc(ref, { ...s, unsynced: false, syncedAt: Timestamp.now() }, { merge: true });
                            s.unsynced = false;
                        } catch (e) { }
                    }
                };

                const openSessions = computed(() => sessions.value.filter(s => s.status === 'open'));
                const closedSessions = computed(() => sessions.value.filter(s => s.status === 'closed'));

                return {
                    currentView, isOnline, newSessionName, newItemName, newItemQty, newItemType, searchQuery, itemInput, showScanner,
                    openSessions, closedSessions, activeSession, sortedItems, filteredInventory,
                    createSession, openSession, addItem, removeItem, closeActiveSession, formatDate, closeScannerAndBack,
                    toggleScanner, stopScanner, exportPdf
                };
            }
        }).mount('#app');
    </script>
</body>

</html>
