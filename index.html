<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carico Merci Smart</title>
    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 (via CDN) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Barcode Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.2s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        .card {
            @apply bg-white rounded-xl shadow-sm border border-gray-100 p-6;
        }

        .btn {
            @apply px-4 py-2 rounded-lg font-medium transition-colors flex items-center justify-center gap-2;
        }

        .btn-primary {
            @apply bg-indigo-600 text-white hover:bg-indigo-700;
        }

        .btn-success {
            @apply bg-emerald-600 text-white hover:bg-emerald-700;
        }

        .btn-danger {
            @apply bg-red-500 text-white hover:bg-red-600;
        }

        .btn-ghost {
            @apply text-gray-500 hover:bg-gray-100;
        }

        .input {
            @apply px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 w-full;
        }

        #reader {
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Status Bar -->
        <div
            :class="['py-2 text-center text-sm font-medium text-white transition-colors', isOnline ? 'bg-indigo-600' : 'bg-red-500']">
            <span v-if="isOnline" class="flex items-center justify-center gap-2">
                <i data-lucide="wifi"></i> Online - Sincronizzazione Attiva
            </span>
            <span v-else class="flex items-center justify-center gap-2">
                <i data-lucide="wifi-off"></i> Offline - Modifiche Salvate in Locale (Cache)
            </span>
        </div>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-6 max-w-4xl mx-auto w-full">

            <!-- VIEW: DASHBOARD -->
            <div v-if="currentView === 'dashboard'" class="space-y-6">
                <!-- Header -->
                <div
                    class="flex flex-col md:flex-row gap-4 justify-between items-center bg-white p-4 rounded-xl shadow-sm">
                    <h1 class="text-2xl font-bold text-gray-800">ðŸ“¦ Carico Merci</h1>
                    <div class="flex gap-2">
                        <button @click="currentView = 'inventory'"
                            class="btn bg-indigo-50 text-indigo-600 hover:bg-indigo-100">
                            <i data-lucide="package"></i> Giacenza Totale
                        </button>
                    </div>
                </div>

                <!-- Create Session -->
                <div class="card flex gap-3">
                    <input v-model="newSessionName" @keyup.enter="createSession" type="text"
                        placeholder="Nome nuova sessione..." class="input">
                    <button @click="createSession" class="btn btn-primary shrink-0">
                        <i data-lucide="plus"></i> Nuova
                    </button>
                </div>

                <!-- Active Sessions -->
                <section>
                    <h2 class="text-lg font-bold text-gray-700 mb-3 ml-1 flex items-center gap-2"><span
                            class="w-2 h-2 rounded-full bg-emerald-500"></span> Sessioni Attive</h2>
                    <div class="grid gap-4 md:grid-cols-2">
                        <div v-for="session in openSessions" :key="session.id" @click="openSession(session.id)"
                            class="card hover:border-indigo-300 cursor-pointer transition-all group relative">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-gray-800 text-lg">{{ session.name }}</h3>
                                <i data-lucide="chevron-right" class="text-gray-300 group-hover:text-indigo-500"></i>
                            </div>
                            <p class="text-gray-500 text-sm mt-1">{{ session.items.length }} articoli registrati</p>
                            <span v-if="session.unsynced"
                                class="absolute top-4 right-10 text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full">Non
                                Sincronizzato</span>
                        </div>
                        <div v-if="openSessions.length === 0"
                            class="p-8 text-center text-gray-400 bg-white rounded-xl border border-dashed border-gray-300">
                            Nessuna sessione attiva
                        </div>
                    </div>
                </section>

                <!-- Closed Sessions -->
                <section>
                    <h2 class="text-lg font-bold text-gray-700 mb-3 ml-1 flex items-center gap-2"><i
                            data-lucide="history" size="18"></i> Storico</h2>
                    <div class="bg-white rounded-xl border border-gray-200 divide-y divide-gray-100">
                        <div v-for="session in closedSessions" :key="session.id"
                            class="p-4 flex justify-between items-center hover:bg-gray-50">
                            <div>
                                <h4 class="font-medium text-gray-800">{{ session.name }}</h4>
                                <span class="text-xs text-gray-500">Chiusa il {{ formatDate(session.closedAt) }} â€¢ {{
                                    session.items.length }} articoli</span>
                            </div>
                            <button @click="openSession(session.id)"
                                class="btn btn-ghost btn-sm text-sm border">Vedi</button>
                        </div>
                    </div>
                </section>
            </div>

            <!-- VIEW: SESSION DETAIL -->
            <div v-if="currentView === 'session'" class="space-y-4">
                <div class="flex items-center justify-between">
                    <button @click="closeScannerAndBack" class="btn btn-ghost -ml-2">
                        <i data-lucide="arrow-left"></i> Indietro
                    </button>
                    <div class="flex gap-2">
                        <button v-if="activeSession.status === 'closed'" @click="exportPdf('session')"
                            class="btn btn-ghost text-red-600 bg-red-50 hover:bg-red-100">
                            <i data-lucide="file-down"></i> PDF
                        </button>
                        <span
                            :class="['px-3 py-1 rounded-full text-sm font-bold flex items-center', activeSession.status === 'open' ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600']">
                            {{ activeSession.status === 'open' ? 'ðŸŸ¢ In Corso' : 'ðŸ”’ Chiusa' }}
                        </span>
                    </div>
                </div>

                <div class="card">
                    <h1 class="text-2xl font-bold text-gray-800 mb-1">{{ activeSession.name }}</h1>
                    <p class="text-sm text-gray-500">Creata il {{ formatDate(activeSession.createdAt) }}</p>
                </div>

                <!-- Scanner UI -->
                <div v-show="showScanner" class="card bg-gray-900 p-2">
                    <div id="reader" class="rounded-lg overflow-hidden"></div>
                    <button @click="stopScanner" class="w-full btn btn-danger mt-2">Chiudi Scanner</button>
                </div>

                <!-- Input Form (Only if Open) -->
                <div v-if="activeSession.status === 'open'" class="card space-y-3 bg-indigo-50 border-indigo-100">
                    <h3 class="font-bold text-indigo-900">Aggiungi Articolo</h3>
                    <div class="flex flex-col md:flex-row gap-3">
                        <button @click="toggleScanner" class="btn bg-gray-800 text-white hover:bg-gray-900 shrink-0"
                            title="Scansiona Barcode">
                            <i data-lucide="scan-barcode"></i>
                        </button>
                        <input v-model="newItemName" ref="itemInput" type="text" placeholder="Nome / Barcode"
                            class="input flex-[2] bg-white">
                        <input v-model.number="newItemQty" type="number" placeholder="Qta" class="input flex-1 bg-white"
                            @keyup.enter="addItem">
                        <button @click="addItem" class="btn btn-primary h-[50px] w-full md:w-auto px-6">
                            <i data-lucide="plus"></i>
                        </button>
                    </div>
                </div>

                <!-- Item List -->
                <div class="card p-0 overflow-hidden">
                    <div class="p-4 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
                        <span class="font-semibold text-gray-600">{{ activeSession.items.length }} Articoli</span>
                        <button v-if="activeSession.status === 'open'" @click="closeActiveSession"
                            class="btn btn-success text-sm py-1 px-3">
                            <i data-lucide="check-circle" width="16"></i> Termina e Salva
                        </button>
                    </div>
                    <ul class="divide-y divide-gray-100">
                        <li v-for="(item, idx) in activeSession.items" :key="idx"
                            class="p-4 flex justify-between items-center hover:bg-gray-50">
                            <span class="font-medium text-gray-800">{{ item.name }}</span>
                            <div class="flex items-center gap-3">
                                <span class="bg-gray-100 text-gray-800 font-mono font-bold px-3 py-1 rounded">{{
                                    item.quantity }}</span>
                                <button v-if="activeSession.status === 'open'" @click="removeItem(idx)"
                                    class="text-red-400 hover:text-red-600">
                                    <i data-lucide="trash-2" width="18"></i>
                                </button>
                            </div>
                        </li>
                        <li v-if="activeSession.items.length === 0" class="p-8 text-center text-gray-400">
                            Nessun articolo inserito.
                        </li>
                    </ul>
                </div>
            </div>

            <!-- VIEW: INVENTORY -->
            <div v-if="currentView === 'inventory'" class="space-y-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button @click="currentView = 'dashboard'"
                            class="btn btn-ghost rounded-full w-10 h-10 p-0 flex items-center justify-center">
                            <i data-lucide="arrow-left"></i>
                        </button>
                        <h1 class="text-2xl font-bold text-gray-800">Giacenza Totale</h1>
                    </div>
                    <button @click="exportPdf('inventory')"
                        class="btn btn-ghost text-red-600 bg-red-50 hover:bg-red-100">
                        <i data-lucide="file-down"></i> Export PDF
                    </button>
                </div>

                <div class="relative">
                    <input v-model="searchQuery" type="text" placeholder="Cerca prodotto..." class="input pl-11">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"
                        width="20"></i>
                </div>

                <div class="card p-0 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-4 font-semibold text-gray-600">Prodotto</th>
                                <th class="p-4 font-semibold text-gray-600 text-right">Totale</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr v-for="item in filteredInventory" :key="item.name" class="hover:bg-gray-50">
                                <td class="p-4 font-medium text-gray-800">{{ item.name }}</td>
                                <td class="p-4 text-right font-bold text-indigo-600">{{ item.quantity }}</td>
                            </tr>
                            <tr v-if="filteredInventory.length === 0">
                                <td colspan="2" class="p-8 text-center text-gray-400">
                                    {{ searchQuery ? 'Nessun prodotto trovato.' : 'Nessun dato in magazzino.' }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURE FIREBASE HERE
        const firebaseConfig = {
            // Replace with your keys
            apiKey: "YOUR_API_KEY_HERE",
            projectId: "YOUR_PROJECT_ID_HERE"
        };

        // Initialize Firebase specific logic if config is present
        let db = null;
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                console.log("Firebase initialized");
            }
        } catch (e) {
            console.error("Firebase init failed", e);
        }

        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // State
                const currentView = ref('dashboard'); // dashboard, session, inventory
                const isOnline = ref(navigator.onLine);
                const sessions = ref([]);
                const activeSessionId = ref(null);
                const newSessionName = ref('');

                const newItemName = ref('');
                const newItemQty = ref('');
                const searchQuery = ref('');
                const itemInput = ref(null); // Ref for focus

                // Scanner State
                const showScanner = ref(false);
                let html5QrcodeScanner = null;

                // Load from LocalStorage
                onMounted(() => {
                    const saved = localStorage.getItem('cm_sessions');
                    if (saved) {
                        try {
                            // Deserialize dates properly would be better, but strings OK for simple display
                            sessions.value = JSON.parse(saved);
                        } catch (e) { console.error(e) }
                    }

                    window.addEventListener('online', () => { isOnline.value = true; syncData(); });
                    window.addEventListener('offline', () => isOnline.value = false);

                    // Lucide icons
                    nextTick(() => lucide.createIcons());
                });

                // Persistence Watcher
                watch(sessions, (newVal) => {
                    localStorage.setItem('cm_sessions', JSON.stringify(newVal));
                    // Trigger sync if online
                    if (isOnline.value) syncData();
                    // Re-render icons on DOM updates
                    setTimeout(() => lucide.createIcons(), 100);
                }, { deep: true });

                watch(currentView, () => {
                    if (currentView.value !== 'session') stopScanner();
                    setTimeout(() => lucide.createIcons(), 50);
                });

                // Computed
                const openSessions = computed(() => sessions.value.filter(s => s.status === 'open').sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)));
                const closedSessions = computed(() => sessions.value.filter(s => s.status === 'closed').sort((a, b) => new Date(b.closedAt) - new Date(a.closedAt)));

                const activeSession = computed(() => sessions.value.find(s => s.id === activeSessionId.value) || {});

                const inventory = computed(() => {
                    const map = new Map();
                    closedSessions.value.forEach(sess => {
                        sess.items.forEach(item => {
                            const k = item.name.toLowerCase().trim();
                            const curr = map.get(k) || { name: item.name, quantity: 0 };
                            map.set(k, { ...curr, quantity: curr.quantity + item.quantity });
                        });
                    });
                    return Array.from(map.values());
                });

                const filteredInventory = computed(() => {
                    if (!searchQuery.value) return inventory.value;
                    return inventory.value.filter(i => i.name.toLowerCase().includes(searchQuery.value.toLowerCase()));
                });

                // Actions
                const createSession = () => {
                    const name = newSessionName.value.trim() || `Carico ${new Date().toLocaleDateString()}`;
                    const newSess = {
                        id: crypto.randomUUID(),
                        name,
                        createdAt: new Date().toISOString(),
                        status: 'open',
                        items: [],
                        unsynced: true // Mark as dirty
                    };
                    sessions.value.push(newSess);
                    newSessionName.value = '';
                    openSession(newSess.id);
                };

                const openSession = (id) => {
                    activeSessionId.value = id;
                    currentView.value = 'session';
                };

                const addItem = () => {
                    if (!newItemName.value || !newItemQty.value) return;
                    const session = sessions.value.find(s => s.id === activeSessionId.value);
                    if (session) {
                        session.items.push({
                            name: newItemName.value,
                            quantity: parseInt(newItemQty.value)
                        });
                        session.unsynced = true; // Mark modified
                        newItemName.value = '';
                        newItemQty.value = '';
                        // Keep focus
                        nextTick(() => itemInput.value?.focus());
                    }
                };

                const removeItem = (idx) => {
                    const session = sessions.value.find(s => s.id === activeSessionId.value);
                    if (session) {
                        session.items.splice(idx, 1);
                        session.unsynced = true;
                    }
                };

                const closeActiveSession = () => {
                    if (!confirm("Confermi di voler chiudere la sessione?\nI prodotti verranno aggiunti alla giacenza totale.")) return;
                    const session = sessions.value.find(s => s.id === activeSessionId.value);
                    if (session) {
                        session.status = 'closed';
                        session.closedAt = new Date().toISOString();
                        session.unsynced = true;
                        currentView.value = 'dashboard';
                    }
                };

                const closeScannerAndBack = () => {
                    stopScanner();
                    currentView.value = 'dashboard';
                }

                // SCANNER LOGIC
                const toggleScanner = () => {
                    if (showScanner.value) {
                        stopScanner();
                    } else {
                        showScanner.value = true;
                        nextTick(() => {
                            html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
                            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
                        });
                    }
                };

                const onScanSuccess = (decodedText) => {
                    newItemName.value = decodedText;
                    // Play beep ?
                    stopScanner();
                    nextTick(() => itemInput.value?.focus());
                };

                const onScanFailure = (error) => {
                    // console.warn(error);
                };

                const stopScanner = () => {
                    showScanner.value = false;
                    if (html5QrcodeScanner) {
                        html5QrcodeScanner.clear().catch(error => console.error("Failed to clear html5QrcodeScanner. ", error));
                        html5QrcodeScanner = null;
                    }
                };

                // PDF EXPORT
                const exportPdf = (type) => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    if (type === 'inventory') {
                        doc.text("Giacenza Totale Magazzino", 14, 20);
                        doc.setFontSize(10);
                        doc.text(`Generato il: ${new Date().toLocaleString()}`, 14, 28);

                        const tableData = filteredInventory.value.map(item => [item.name, item.quantity]);

                        doc.autoTable({
                            startY: 35,
                            head: [['Prodotto', 'QuantitÃ ']],
                            body: tableData,
                        });
                        doc.save(`Giacenza_${new Date().toISOString().slice(0, 10)}.pdf`);
                    } else if (type === 'session') {
                        const sess = activeSession.value;
                        doc.text(`Sessione: ${sess.name}`, 14, 20);
                        doc.setFontSize(10);
                        doc.text(`Data: ${formatDate(sess.createdAt)}`, 14, 28);

                        const tableData = sess.items.map(item => [item.name, item.quantity]);

                        doc.autoTable({
                            startY: 35,
                            head: [['Prodotto', 'QuantitÃ ']],
                            body: tableData,
                        });
                        doc.save(`Sessione_${sess.name}.pdf`);
                    }
                };

                const formatDate = (iso) => {
                    if (!iso) return '';
                    return new Date(iso).toLocaleString('it-IT', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                };

                // SYNC LOGIC
                const syncData = async () => {
                    if (!db || !isOnline.value) return;

                    const dirtySessions = sessions.value.filter(s => s.unsynced);
                    if (dirtySessions.length === 0) return;

                    console.log(`Syncing ${dirtySessions.length} sessions...`);

                    for (const sess of dirtySessions) {
                        try {
                            // Deep copy to remove internal flags if needed, or structuredClone
                            // We save everything to Firestore
                            const docRef = doc(collection(db, "sessions"), sess.id);
                            await setDoc(docRef, { ...sess, unsynced: false, lastSync: Timestamp.now() }, { merge: true });

                            // Update local state to clean
                            sess.unsynced = false;
                        } catch (e) {
                            console.error("Sync failed for", sess.id, e);
                        }
                    }
                };

                return {
                    currentView, isOnline, newSessionName, newItemName, newItemQty, searchQuery, itemInput, showScanner,
                    openSessions, closedSessions, activeSession, filteredInventory,
                    createSession, openSession, addItem, removeItem, closeActiveSession, formatDate, closeScannerAndBack,
                    toggleScanner, stopScanner, exportPdf
                };
            }
        }).mount('#app');
    </script>
</body>

</html>
