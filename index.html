<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Magazzino Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* Ottimizzazioni per Mobile e UX */
        body { touch-action: manipulation; -webkit-user-select: none; user-select: none; }
        
        /* Animazione pulsante scansione */
        .scan-btn { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }

        /* Toggle Switch Carico/Scarico */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #ef4444; /* Rosso per scarico */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #ef4444;
        }
        
        /* Modali */
        .modal-enter { opacity: 0; transform: scale(0.9); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.3s, transform 0.3s; }
    </style>
</head>
<body class="bg-gray-900 text-white pb-32">

    <!-- Header Configurazione Sessione -->
    <div class="fixed top-0 w-full bg-gray-800 border-b border-gray-700 z-30 p-3 shadow-lg">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-lg font-bold text-indigo-400 flex items-center">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                Magazzino Pro
            </h1>
            <button onclick="downloadJSON()" class="bg-gray-700 hover:bg-gray-600 text-xs text-white px-2 py-1 rounded border border-gray-600 flex items-center">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Export
            </button>
        </div>

        <!-- Controlli Operatore e Modalit√† -->
        <div class="grid grid-cols-2 gap-2">
            <div>
                <input type="text" id="operatorName" placeholder="Nome Operatore" class="w-full bg-gray-900 text-white text-sm border border-gray-600 rounded px-2 py-1 focus:border-indigo-500 outline-none" onchange="saveSessionSettings()">
            </div>
            
            <div class="flex items-center justify-end relative">
                <span class="mr-2 text-xs font-bold" id="modeLabel">CARICO</span>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="modeToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0 top-0" onclick="toggleMode()"/>
                    <label for="modeToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-green-500 cursor-pointer transition-colors duration-300"></label>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="mt-32 px-4">
        
        <!-- Dashboard Statistiche -->
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="bg-gray-800 p-3 rounded-xl border border-gray-700 shadow-lg text-center">
                <div class="text-gray-400 text-[10px] uppercase tracking-wider">Scatole/Colli</div>
                <div class="text-3xl font-bold text-white" id="scanCount">0</div>
            </div>
            <div class="bg-gray-800 p-3 rounded-xl border border-gray-700 shadow-lg text-center relative overflow-hidden">
                <div class="text-gray-400 text-[10px] uppercase tracking-wider">Pezzi Totali</div>
                <div class="text-3xl font-bold text-indigo-400" id="piecesCount">0</div>
                <!-- Indicatore Modalit√† Sfondo -->
                <div id="modeIndicator" class="absolute bottom-0 left-0 w-full h-1 bg-green-500"></div>
            </div>
        </div>

        <button onclick="showSummary()" class="w-full mb-6 bg-gray-700 hover:bg-gray-600 text-gray-200 py-2 rounded-lg text-sm font-semibold flex items-center justify-center border border-gray-600">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
            üìã Vedi Riepilogo Dettagliato
        </button>

        <!-- Lista Ultimi Movimenti -->
        <h3 class="text-gray-500 text-xs font-bold uppercase mb-2 pl-1">Cronologia Recente</h3>
        <div id="logContainer" class="space-y-2 pb-20">
            <div class="text-center text-gray-600 py-8 text-sm italic">Nessuna scansione in questa sessione</div>
        </div>
    </div>

    <!-- Pulsantone Scanner (Home) -->
    <div class="fixed bottom-6 left-0 w-full flex justify-center z-20 pointer-events-none">
        <button onclick="startScanner()" class="pointer-events-auto scan-btn bg-indigo-600 active:bg-indigo-700 text-white rounded-full w-20 h-20 flex items-center justify-center shadow-2xl border-4 border-gray-900 transform transition active:scale-95">
            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
        </button>
    </div>

    <!-- Scanner Overlay (Fotocamera) -->
    <div id="scannerOverlay" class="hidden fixed inset-0 bg-black z-50 flex flex-col relative">
        <div class="p-4 flex justify-between items-center bg-black z-20">
            <span class="text-white font-bold text-lg">Inquadra Codice</span>
            <button onclick="stopScannerAndClose()" class="text-gray-300 bg-gray-800 px-4 py-2 rounded font-semibold">Annulla</button>
        </div>
        
        <div class="flex-grow relative bg-black overflow-hidden">
            <div id="reader" class="w-full h-full"></div>
            <!-- Mirino Grafico -->
            <div class="absolute inset-0 border-2 border-red-500 opacity-30 pointer-events-none" style="top: 25%; bottom: 25%; left: 10%; right: 10%;"></div>
        </div>

        <div class="p-6 bg-gray-900 text-center text-gray-400 text-sm z-20 pb-10">
            Posiziona il codice a barre nel riquadro
        </div>
    </div>

    <!-- Result Modal (Successo & Prossimo) -->
    <div id="resultModal" class="hidden fixed inset-0 bg-black bg-opacity-95 z-50 flex flex-col items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm text-center shadow-2xl border border-gray-700 transform transition-all">
            
            <div id="resultIconCtx" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg bg-green-500">
                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
            </div>

            <h2 class="text-3xl font-bold text-white mb-2" id="resTitle">PRESO!</h2>
            
            <div class="bg-gray-700/50 rounded-lg p-4 mb-4 border border-gray-600">
                <div class="text-gray-400 text-xs uppercase mb-1">Prodotto</div>
                <div class="text-xl font-bold text-white leading-tight mb-3" id="resProduct">Nome Prodotto</div>
                
                <div class="flex justify-between items-end border-t border-gray-600 pt-3">
                    <div class="text-left">
                        <div class="text-xs text-gray-400">Barcode</div>
                        <div class="font-mono text-indigo-300 text-sm" id="resBarcode">...</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-400" id="resQtyLabel">Quantit√†</div>
                        <div class="text-3xl font-bold text-green-400" id="resQty">+0</div>
                    </div>
                </div>
            </div>

            <!-- Pulsanti Azione -->
            <div class="space-y-3">
                <button onclick="startScanner()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl text-xl shadow-lg flex items-center justify-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path></svg>
                    PROSSIMO
                </button>
                
                <button onclick="editMappingFromModal()" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium py-3 rounded-xl flex items-center justify-center border border-gray-600">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    Modifica Associazione
                </button>
            </div>
            
            <button onclick="closeResultModal()" class="mt-4 text-gray-500 text-sm hover:text-white transition-colors">Chiudi e torna al menu</button>
        </div>
    </div>

    <!-- Summary Modal (Riepilogo) -->
    <div id="summaryModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex flex-col pt-10 px-4 pb-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-white">Riepilogo Sessione</h2>
            <button onclick="closeSummary()" class="bg-gray-700 p-2 rounded-full text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="flex-grow overflow-y-auto bg-gray-800 rounded-xl border border-gray-700 p-2">
            <table class="w-full text-sm text-left text-gray-400">
                <thead class="text-xs text-gray-500 uppercase bg-gray-900 sticky top-0">
                    <tr>
                        <th class="px-2 py-3 rounded-tl-lg">Prodotto</th>
                        <th class="px-2 py-3 text-right rounded-tr-lg">Tot. Pezzi</th>
                    </tr>
                </thead>
                <tbody id="summaryBody" class="divide-y divide-gray-700">
                    <!-- Popolato JS -->
                </tbody>
            </table>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-800">
             <div class="flex justify-between items-center text-gray-300 text-sm mb-2">
                <span>Operatore:</span>
                <span id="summaryOp" class="font-bold text-white">---</span>
            </div>
            <button onclick="downloadJSON()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg">
                Esporta Dati
            </button>
        </div>
    </div>

    <!-- Config Modal (Nuovo/Edit) -->
    <div id="configModal" class="hidden fixed inset-0 bg-black bg-opacity-95 z-50 flex items-center justify-center px-4">
        <div class="bg-gray-800 w-full max-w-md p-6 rounded-2xl shadow-2xl border border-gray-600">
            <h3 class="text-xl font-bold text-white mb-1" id="configTitle">Configura Codice</h3>
            <p class="text-indigo-400 font-mono text-sm mb-6 bg-gray-900 p-2 rounded text-center border border-gray-700" id="modalBarcode">---</p>
            
            <label class="block text-xs text-gray-400 uppercase mb-2 font-bold">1. Seleziona Prodotto</label>
            <div class="relative mb-6">
                <select id="modalProduct" class="w-full bg-gray-700 text-white p-4 pr-8 rounded-xl border border-gray-600 focus:border-indigo-500 outline-none appearance-none font-bold text-lg">
                    <!-- Prodotti -->
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>

            <label class="block text-xs text-gray-400 uppercase mb-2 font-bold">2. Pezzi per Scatola/Collo</label>
            <div class="flex items-center mb-8">
                <button onclick="adjQty(-1)" class="bg-gray-600 hover:bg-gray-500 w-16 py-4 rounded-l-xl text-xl font-bold text-white border-r border-gray-700">-</button>
                <input type="number" id="modalQty" value="1" class="w-full bg-gray-900 text-center text-white py-4 border-y border-gray-700 font-bold text-2xl focus:outline-none">
                <button onclick="adjQty(1)" class="bg-gray-600 hover:bg-gray-500 w-16 py-4 rounded-r-xl text-xl font-bold text-white border-l border-gray-700">+</button>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeConfigModal()" class="w-full bg-gray-700 text-gray-300 font-bold py-3 rounded-xl">Annulla</button>
                <button onclick="saveConfig()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg">Salva</button>
            </div>
        </div>
    </div>

    <!-- Audio Files (Preload) -->
    <!-- Bip Corto per Successo -->
    <audio id="beepOk" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3" type="audio/mpeg">
    </audio>
    <!-- Suono Diverso per Nuovo Codice/Attenzione -->
    <audio id="beepNew" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" type="audio/mpeg">
    </audio>

<script>
    // --- DATABASE PRODOTTI ---
    const productList = [
        { id: 1, name: "BBRAUN - XEVONTA 1,5" }, { id: 2, name: "BBRAUN - XEVONTA 1.8" },
        { id: 3, name: "BBRAUN - DIACAP" }, { id: 4, name: "GAMBRO - NEPHRAL 400" },
        { id: 5, name: "GAMBRO - U-9000" }, { id: 6, name: "ESTOR - BK 1.3 F" },
        { id: 7, name: "ESTOR - BK 1.6 F" }, { id: 8, name: "ESTOR - BK 2.1 F" },
        { id: 9, name: "ESTOR - BG 1.6U" }, { id: 10, name: "ESTOR - TORALIGTH NV 15U" },
        { id: 11, name: "BELLCO - KIT HER LINEE" }, { id: 12, name: "GAMBRO - ARTIS" },
        { id: 13, name: "GAMBRO - EVACLEAN" }, { id: 14, name: "BBRAUN - LINEE SENZA SET" },
        { id: 15, name: "BBRAUN - LINEE CON SET" }, { id: 16, name: "BBRAUN - LINEE MONOAGO" },
        { id: 17, name: "BBRAUN - 874" }, { id: 18, name: "GAMBRO - HOSPASOL" },
        { id: 19, name: "GAMBRO - SAFEBAG KB" }, { id: 20, name: "GENERICO - PRONTOPRIME" },
        { id: 21, name: "BBRAUN - BICART" }, { id: 22, name: "BELLCO - BIFLEXY BICARBON." },
        { id: 23, name: "BELLCO - LYMPHA SOL ACIDA" }, { id: 24, name: "AGHI - 15 G" },
        { id: 25, name: "AGHI - 16 G" }, { id: 26, name: "AGHI - MONOAGO" },
        { id: 27, name: "COVIDIEN - CVC 11-15" }, { id: 28, name: "COVIDIEN - CVC 11-20" },
        { id: 29, name: "GAMBRO - CLEARCART A" }, { id: 30, name: "GAMBRO - CLEARCART C" },
        { id: 31, name: "MAROVAN - SALE PER OSMOSI" }, { id: 32, name: "ESTOR - FISTO BLOCK" },
        { id: 33, name: "GENERICO - PREMIFISTOLA" }, { id: 34, name: "GENERICO - KIT CVC" },
        { id: 35, name: "GENERICO - KIT FAV" }, { id: 36, name: "GENERICO - TAURO LOCK URO" },
        { id: 37, name: "GENERICO - TAURO LOCK EPA" }, { id: 38, name: "GENERICO - IVOR 3500" },
        { id: 39, name: "GENERICO - IVOR 2500" }
    ];

    // --- STATE ---
    // Mappings: Barcode -> { productId, boxQty }
    let mappings = JSON.parse(localStorage.getItem('scanner_mappings') || '{}');
    
    // Log Sessione Corrente (Non salvato in Inventory globale, ma in sessione)
    // Struttura Log: { timestamp, barcode, productId, productName, boxQty, totalQty, operator, type (IN/OUT) }
    let sessionLogs = [];
    
    // Impostazioni Sessione
    let sessionSettings = JSON.parse(localStorage.getItem('scanner_session_settings') || '{"operator":"", "mode":"IN"}');
    
    // --- INIT ---
    function init() {
        const select = document.getElementById('modalProduct');
        productList.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.text = p.name;
            select.appendChild(opt);
        });

        // Ripristina UI
        document.getElementById('operatorName').value = sessionSettings.operator;
        if(sessionSettings.mode === 'OUT') {
            document.getElementById('modeToggle').checked = true;
        }
        updateModeUI();
        updateDashboard();
    }

    // --- AUDIO HELPER (UNLOCK) ---
    function unlockAudio() {
        const audios = [document.getElementById('beepOk'), document.getElementById('beepNew')];
        audios.forEach(a => {
            a.play().then(() => {
                a.pause();
                a.currentTime = 0;
            }).catch(() => {});
        });
    }

    // --- SESSION & UI LOGIC ---
    function saveSessionSettings() {
        const op = document.getElementById('operatorName').value;
        const mode = document.getElementById('modeToggle').checked ? 'OUT' : 'IN';
        sessionSettings = { operator: op, mode: mode };
        localStorage.setItem('scanner_session_settings', JSON.stringify(sessionSettings));
        updateModeUI();
    }

    function toggleMode() {
        saveSessionSettings();
    }

    function updateModeUI() {
        const isOut = sessionSettings.mode === 'OUT';
        const label = document.getElementById('modeLabel');
        const indicator = document.getElementById('modeIndicator');
        const toggleLabel = document.querySelector('.toggle-label');
        
        if (isOut) {
            label.innerText = "SCARICO";
            label.className = "mr-2 text-xs font-bold text-red-500";
            indicator.className = "absolute bottom-0 left-0 w-full h-1 bg-red-500";
            toggleLabel.style.backgroundColor = "#ef4444";
        } else {
            label.innerText = "CARICO";
            label.className = "mr-2 text-xs font-bold text-green-500";
            indicator.className = "absolute bottom-0 left-0 w-full h-1 bg-green-500";
            toggleLabel.style.backgroundColor = "#10b981";
        }
    }

    // --- SCANNER LOGIC ---
    let scanner = null;
    let isProcessing = false;
    let lastScannedCode = null; // Per editing

    function startScanner() {
        // Unlock Audio al primo click
        unlockAudio();

        document.getElementById('resultModal').classList.add('hidden');
        document.getElementById('configModal').classList.add('hidden');
        
        const overlay = document.getElementById('scannerOverlay');
        overlay.classList.remove('hidden');
        isProcessing = false;

        if (!scanner) {
            scanner = new Html5Qrcode("reader");
        }
        
        const config = { fps: 15, qrbox: 250, aspectRatio: 1.0 };

        scanner.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                console.error("Errore cam:", err);
                alert("Errore fotocamera. Assicurati di essere in HTTPS o localhost.");
                overlay.classList.add('hidden');
            });
    }

    function stopScannerAndClose() {
        if (scanner) {
            scanner.stop().then(() => {
                document.getElementById('scannerOverlay').classList.add('hidden');
            }).catch(err => document.getElementById('scannerOverlay').classList.add('hidden'));
        } else {
            document.getElementById('scannerOverlay').classList.add('hidden');
        }
    }

    function onScanSuccess(decodedText) {
        if (isProcessing) return;
        isProcessing = true; 

        if(scanner) {
            scanner.stop().then(() => {
                document.getElementById('scannerOverlay').classList.add('hidden');
                processScan(decodedText);
            }).catch(() => {
                document.getElementById('scannerOverlay').classList.add('hidden');
                processScan(decodedText);
            });
        }
    }

    function processScan(decodedText) {
        lastScannedCode = decodedText; // Salva per eventuale edit
        
        if (mappings[decodedText]) {
            // CODICE NOTO
            const map = mappings[decodedText];
            registerTransaction(map);
            
            // Audio Bip OK
            const audio = document.getElementById('beepOk');
            audio.currentTime = 0; 
            audio.play().catch(e => console.log("Audio block", e));

            showResultModal(decodedText, map);
        } else {
            // CODICE NUOVO
            const audio = document.getElementById('beepNew');
            audio.currentTime = 0; 
            audio.play();
            showConfigModal(decodedText, true); // true = new mode
        }
    }

    function registerTransaction(map) {
        const isOut = sessionSettings.mode === 'OUT';
        const qty = parseInt(map.boxQty);
        const finalQty = isOut ? -qty : qty; // Negativo se scarico
        const prod = productList.find(p => p.id === map.productId);

        const logEntry = {
            id: Date.now(), // Unique ID per la riga
            timestamp: new Date().toISOString(),
            barcode: lastScannedCode,
            productId: map.productId,
            productName: prod ? prod.name : "Ignoto",
            boxQty: qty,
            totalQty: finalQty, // +10 o -10
            operator: sessionSettings.operator || "Anonimo",
            type: sessionSettings.mode
        };

        sessionLogs.unshift(logEntry);
        updateDashboard();
    }

    // --- MODALS ---
    function showResultModal(barcode, map) {
        const prod = productList.find(p => p.id === map.productId);
        const isOut = sessionSettings.mode === 'OUT';
        
        document.getElementById('resTitle').innerText = isOut ? "SCARICATO!" : "CARICATO!";
        document.getElementById('resProduct').innerText = prod ? prod.name : "Sconosciuto";
        document.getElementById('resBarcode').innerText = barcode;
        
        const qtyEl = document.getElementById('resQty');
        const iconCtx = document.getElementById('resultIconCtx');
        
        if (isOut) {
            qtyEl.innerText = `-${map.boxQty}`;
            qtyEl.className = "text-3xl font-bold text-red-400";
            iconCtx.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg bg-red-500";
        } else {
            qtyEl.innerText = `+${map.boxQty}`;
            qtyEl.className = "text-3xl font-bold text-green-400";
            iconCtx.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg bg-green-500";
        }

        document.getElementById('resultModal').classList.remove('hidden');
    }

    function closeResultModal() {
        document.getElementById('resultModal').classList.add('hidden');
    }

    // --- EDITING ---
    function editMappingFromModal() {
        // Apre la config pre-compilata per l'ultimo codice scansionato
        // Nota: Questo non cancella l'ultimo log, ma aggiorna la mappa per il futuro.
        // Se si volesse cancellare l'ultimo log errato, bisognerebbe farlo qui.
        // Per semplicit√†, aggiorniamo solo la mappa futura.
        if(lastScannedCode && mappings[lastScannedCode]) {
            closeResultModal();
            showConfigModal(lastScannedCode, false); // false = edit mode
        }
    }

    function showConfigModal(barcode, isNew) {
        document.getElementById('configModal').classList.remove('hidden');
        document.getElementById('modalBarcode').innerText = barcode;
        document.getElementById('configTitle').innerText = isNew ? "Nuovo Prodotto" : "Modifica Associazione";
        
        // Se esiste gi√†, pre-popola
        if(mappings[barcode]) {
            document.getElementById('modalProduct').value = mappings[barcode].productId;
            document.getElementById('modalQty').value = mappings[barcode].boxQty;
        } else {
            document.getElementById('modalQty').value = 1;
            document.getElementById('modalProduct').selectedIndex = 0;
        }
    }

    function closeConfigModal() {
        document.getElementById('configModal').classList.add('hidden');
    }

    function adjQty(delta) {
        const input = document.getElementById('modalQty');
        let val = parseInt(input.value) + delta;
        if (val < 1) val = 1;
        input.value = val;
    }

    function saveConfig() {
        const barcode = document.getElementById('modalBarcode').innerText;
        const productId = parseInt(document.getElementById('modalProduct').value);
        const qty = parseInt(document.getElementById('modalQty').value);

        // Salva Mappa
        mappings[barcode] = { productId, boxQty: qty };
        localStorage.setItem('scanner_mappings', JSON.stringify(mappings));
        
        closeConfigModal();

        // Se eravamo in fase di scansione nuovo codice, registriamo la transazione ora
        // Se eravamo in edit, non duplichiamo la transazione (l'utente deve riscansionare se vuole applicare il nuovo valore)
        // Ma per UX fluida, se √® nuovo, lo processiamo.
        if (isProcessing) { // isProcessing rimane true finch√© non finisce il flusso "Nuovo"
            registerTransaction(mappings[barcode]);
            const audio = document.getElementById('beepOk');
            audio.currentTime = 0; 
            audio.play();
            showResultModal(barcode, mappings[barcode]);
            isProcessing = false; // Reset
        } else {
            alert("Associazione aggiornata! Le future scansioni useranno la nuova quantit√†.");
        }
    }

    // --- SUMMARY & DASHBOARD ---
    function updateDashboard() {
        // Calcoli Sessione
        let totalPieces = 0;
        
        sessionLogs.forEach(log => {
            // Nota: totalQty √® gi√† negativo se scarico
            totalPieces += log.totalQty;
        });

        document.getElementById('scanCount').innerText = sessionLogs.length;
        document.getElementById('piecesCount').innerText = totalPieces; // Pu√≤ essere negativo se si scarica solo
        
        // Aggiorna lista (ultimi 5)
        const container = document.getElementById('logContainer');
        container.innerHTML = '';
        if (sessionLogs.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-600 py-8 text-sm italic">Pronto a scansionare</div>';
        } else {
            sessionLogs.slice(0, 5).forEach(log => {
                const el = document.createElement('div');
                const isOut = log.type === 'OUT';
                el.className = `bg-gray-800 p-3 rounded-lg flex justify-between items-center border-l-4 ${isOut ? 'border-red-500' : 'border-green-500'} shadow-sm`;
                el.innerHTML = `
                    <div class="overflow-hidden">
                        <div class="font-bold text-sm text-gray-200 truncate">${log.productName}</div>
                        <div class="text-[10px] text-gray-500 flex items-center">
                            <span class="mr-2">${log.timestamp.split('T')[1].split('.')[0]}</span>
                            <span>${log.operator}</span>
                        </div>
                    </div>
                    <div class="text-xl font-bold ${isOut ? 'text-red-400' : 'text-green-400'} whitespace-nowrap ml-2">
                        ${log.totalQty > 0 ? '+' : ''}${log.totalQty}
                    </div>
                `;
                container.appendChild(el);
            });
        }
    }

    function showSummary() {
        // Aggrega per prodotto
        const summary = {}; // { productId: { name, total } }

        sessionLogs.forEach(log => {
            if(!summary[log.productId]) {
                summary[log.productId] = { name: log.productName, total: 0 };
            }
            summary[log.productId].total += log.totalQty;
        });

        const tbody = document.getElementById('summaryBody');
        tbody.innerHTML = '';
        
        Object.values(summary).forEach(item => {
            if(item.total === 0) return; // Nascondi quelli a 0? O mostra? Mostriamo tutto != 0
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-2 py-3 font-medium text-white border-b border-gray-700">${item.name}</td>
                <td class="px-2 py-3 text-right font-bold ${item.total < 0 ? 'text-red-400' : 'text-green-400'} border-b border-gray-700">${item.total}</td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('summaryOp').innerText = sessionSettings.operator || "N/D";
        document.getElementById('summaryModal').classList.remove('hidden');
    }

    function closeSummary() {
        document.getElementById('summaryModal').classList.add('hidden');
    }

    function downloadJSON() {
        const dataExport = {
            timestamp: new Date().toISOString(),
            source: "android_scanner_pro",
            operator: sessionSettings.operator,
            logs: sessionLogs // Esportiamo tutto il log dettagliato
        };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataExport));
        const dlAnchor = document.createElement('a');
        dlAnchor.setAttribute("href", dataStr);
        dlAnchor.setAttribute("download", `sessione_${sessionSettings.operator || 'scan'}_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`);
        document.body.appendChild(dlAnchor);
        dlAnchor.click();
        dlAnchor.remove();
    }

    init();
</script>
</body>
</html>
