<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magazzino Enterprise v3</title>
    <!-- Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        [v-cloak] {
            display: none !important;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f8fafc;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 2rem;
        }

        .card-base {
            background: white;
            border-radius: 1.5rem;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            transition: all 0.2s;
        }

        .card-base:active {
            transform: scale(0.98);
            background: #f1f5f9;
        }

        .btn-action {
            @apply flex flex-col items-center justify-center p-6 rounded-[2rem] border-2 transition-all active:scale-95 text-center gap-3;
        }

        #reader {
            width: 100% !important;
            border-radius: 1.5rem !important;
            overflow: hidden !important;
            border: none !important;
        }

        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak>
        <div class="min-h-screen flex flex-col max-w-xl mx-auto w-full pb-12">

            <!-- Fatal Error Boundary -->
            <div v-if="fatalError" class="p-8 text-center space-y-4">
                <div class="inline-flex p-4 bg-rose-100 text-rose-600 rounded-full"><i data-lucide="alert-circle"
                        class="w-12 h-12"></i></div>
                <h1 class="text-2xl font-black">Errore di Sistema</h1>
                <p class="text-slate-500 font-medium">{{ fatalError }}</p>
                <button @click="location.reload()"
                    class="w-full bg-slate-900 text-white p-4 rounded-2xl font-bold">Riavvia App</button>
            </div>

            <template v-else>
                <!-- Online/Offline Status -->
                <div
                    :class="['py-2 text-center text-[10px] font-black tracking-widest uppercase text-white transition-colors duration-500', isOnline ? 'bg-indigo-600' : 'bg-rose-500']">
                    {{ isOnline ? '● Sistema Online' : '○ Modalità Locale' }}
                </div>

                <div class="flex-1 p-4 md:p-8 space-y-8">

                    <!-- VIEWS -->
                    <!-- DASHBOARD -->
                    <div v-if="currentView === 'dashboard'" class="space-y-10 pt-4">
                        <header>
                            <h1 class="text-3xl font-black tracking-tight text-slate-900">Pannello</h1>
                            <p class="text-slate-400 font-bold text-xs uppercase">Gestione Magazzino</p>
                        </header>

                        <!-- Main 4-Button Grid -->
                        <div class="grid grid-cols-2 gap-4">
                            <button @click="startSession('carico')"
                                class="bg-emerald-50 border-emerald-100 text-emerald-700 hover:border-emerald-500 flex flex-col items-center justify-center p-6 rounded-[2rem] border-2 transition-all active:scale-95 text-center gap-3">
                                <div
                                    class="w-14 h-14 bg-emerald-500 text-white rounded-3xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="plus-square" class="w-7 h-7"></i>
                                </div>
                                <span class="font-black text-sm uppercase tracking-wider">Carico</span>
                            </button>

                            <button @click="startSession('scarico')"
                                class="bg-rose-50 border-rose-100 text-rose-700 hover:border-rose-500 flex flex-col items-center justify-center p-6 rounded-[2rem] border-2 transition-all active:scale-95 text-center gap-3">
                                <div
                                    class="w-14 h-14 bg-rose-500 text-white rounded-3xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="minus-square" class="w-7 h-7"></i>
                                </div>
                                <span class="font-black text-sm uppercase tracking-wider">Scarico</span>
                            </button>

                            <button @click="currentView = 'inventory'"
                                class="bg-indigo-50 border-indigo-100 text-indigo-700 hover:border-indigo-500 flex flex-col items-center justify-center p-6 rounded-[2rem] border-2 transition-all active:scale-95 text-center gap-3">
                                <div
                                    class="w-14 h-14 bg-indigo-500 text-white rounded-3xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="package" class="w-7 h-7"></i>
                                </div>
                                <span class="font-black text-sm uppercase tracking-wider">Giacenza</span>
                            </button>

                            <button @click="currentView = 'reports_menu'"
                                class="bg-amber-50 border-amber-100 text-amber-700 hover:border-amber-500 flex flex-col items-center justify-center p-6 rounded-[2rem] border-2 transition-all active:scale-95 text-center gap-3">
                                <div
                                    class="w-14 h-14 bg-amber-500 text-white rounded-3xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="file-text" class="w-7 h-7"></i>
                                </div>
                                <span class="font-black text-sm uppercase tracking-wider">Report</span>
                            </button>
                        </div>

                        <!-- Recent History List (Mini) -->
                        <div class="space-y-4">
                            <h2 class="text-[10px] font-black text-slate-300 uppercase tracking-widest pl-2">Ultime
                                Sessioni</h2>
                            <div class="space-y-3">
                                <div v-for="s in sortedSessions.slice(0, 3)" :key="s.id" @click="openSession(s.id)"
                                    class="card-base p-4 flex items-center gap-4">
                                    <div
                                        :class="['w-10 h-10 rounded-xl flex items-center justify-center', s.type === 'carico' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600']">
                                        <i :data-lucide="s.type === 'carico' ? 'download' : 'upload'"
                                            class="w-4 h-4"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-bold text-slate-800 text-sm capitalize truncate">{{ s.name }}
                                        </h4>
                                        <p class="text-[9px] font-black text-slate-400">{{ formatDateShort(s.createdAt)
                                            }}</p>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SESSION DETAIL -->
                    <div v-if="currentView === 'session'" class="space-y-6 pt-4">
                        <nav class="flex items-center justify-between">
                            <button @click="closeScannerAndBack"
                                class="p-3 bg-white rounded-2xl shadow-sm border border-slate-100"><i
                                    data-lucide="arrow-left" class="w-5 h-5 text-slate-500"></i></button>
                            <div
                                :class="['px-6 py-2 rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] shadow-sm', activeSession.type === 'carico' ? 'bg-emerald-500 text-white' : 'bg-rose-500 text-white']">
                                {{ activeSession.type }}
                            </div>
                        </nav>

                        <div class="glass-dark p-8 text-white relative overflow-hidden">
                            <div class="relative z-10">
                                <p class="text-white/40 text-[10px] font-black uppercase mb-1">{{
                                    formatDate(activeSession.createdAt) }}</p>
                                <h1 class="text-2xl font-black">{{ activeSession.name }}</h1>
                            </div>
                            <div class="absolute -right-4 -bottom-4 opacity-10">
                                <i :data-lucide="activeSession.type === 'carico' ? 'download' : 'upload'"
                                    class="w-32 h-32"></i>
                            </div>
                        </div>

                        <!-- Scan/Add Section -->
                        <template v-if="activeSession.status === 'open'">
                            <div v-show="showScanner" class="card-base p-2 bg-slate-900 border-none shadow-2xl">
                                <div id="reader"></div>
                                <button @click="stopScanner"
                                    class="w-full py-4 text-white/50 text-[10px] font-black uppercase tracking-widest">Chiudi
                                    Fotocamera</button>
                            </div>

                            <div class="flex gap-3">
                                <button @click="toggleScanner"
                                    class="w-16 h-16 bg-slate-900 text-white rounded-2xl flex items-center justify-center shrink-0 active:scale-90 transition-all">
                                    <i data-lucide="scan" class="w-6 h-6"></i>
                                </button>
                                <input v-model="newItemBarcode" @keyup.enter="handleBarcodeEntry" type="text"
                                    placeholder="Scansiona o digita..."
                                    class="flex-1 px-5 py-4 rounded-2xl border-2 border-slate-100 focus:border-indigo-500 outline-none font-bold text-lg">
                            </div>

                            <div v-if="newItemData" class="flex gap-3 animate-in fade-in slide-in-from-top-2">
                                <input v-model.number="newItemQty" ref="qtyInput" type="number" placeholder="Qtà"
                                    class="w-32 px-5 py-4 rounded-2xl border-2 border-slate-100 focus:border-indigo-500 outline-none font-black text-center text-xl">
                                <button @click="addItem"
                                    :class="['flex-1 font-black uppercase tracking-widest rounded-2xl text-white shadow-lg shadow-black/5', activeSession.type === 'carico' ? 'bg-emerald-500' : 'bg-rose-500']">
                                    Registra
                                </button>
                            </div>
                        </template>

                        <!-- Items Movment Summary -->
                        <div class="space-y-4 pt-4">
                            <div class="flex items-center justify-between border-b border-slate-100 pb-2">
                                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Dettaglio
                                    Articoli</h3>
                                <button v-if="activeSession.status === 'open' && activeSession.items.length"
                                    @click="closeActiveSession"
                                    class="bg-indigo-600 text-white px-5 py-2 rounded-xl text-[10px] font-black uppercase">Finalizza
                                    Invio</button>
                                <button v-if="activeSession.status === 'closed'"
                                    @click="generateSessionPDF(activeSession)"
                                    class="text-rose-500 font-black text-[10px] uppercase">Scarica Report PDF</button>
                            </div>

                            <div class="space-y-2">
                                <div v-for="(item, idx) in sortedItems" :key="idx"
                                    class="card-base py-3 px-4 flex items-center justify-between border-slate-100 shadow-none">
                                    <div class="flex-1 min-w-0 pr-4">
                                        <h4 class="font-bold text-slate-800 truncate">{{ item.productName }}</h4>
                                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">{{
                                            item.barcode }} • {{ item.unitsPerBox }} PZ/CONF</p>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <div class="text-right">
                                            <p
                                                :class="['text-lg font-black font-mono leading-none', activeSession.type === 'carico' ? 'text-emerald-500' : 'text-rose-500']">
                                                {{ item.quantity }}</p>
                                            <p class="text-[8px] font-bold text-slate-300 uppercase">Colli</p>
                                        </div>
                                        <button v-if="activeSession.status === 'open'" @click="removeItem(idx)"
                                            class="w-8 h-8 rounded-lg bg-rose-50 text-rose-300 flex items-center justify-center"><i
                                                data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                                <div v-if="!activeSession.items.length"
                                    class="text-center py-12 text-slate-200 italic font-bold">Nessun movimento
                                    registrato</div>
                            </div>
                        </div>
                    </div>

                    <!-- INVENTORY VIEW -->
                    <div v-if="currentView === 'inventory'" class="space-y-8 pt-4">
                        <header class="flex items-center justify-between">
                            <button @click="currentView = 'dashboard'"
                                class="p-3 bg-white rounded-2xl shadow-sm border border-slate-100"><i
                                    data-lucide="arrow-left" class="w-5 h-5 text-slate-500"></i></button>
                            <button @click="generateInventoryPDF"
                                class="bg-slate-900 text-white px-5 py-3 rounded-2xl flex items-center gap-2 text-[10px] font-black uppercase">
                                <i data-lucide="file-text" class="w-4 h-4"></i> Genera Report Completo
                            </button>
                        </header>

                        <div>
                            <h1 class="text-3xl font-black text-slate-900">Magazzino</h1>
                            <p class="text-slate-400 font-bold text-xs uppercase">Situazione Stock Attuale</p>
                        </div>

                        <div class="relative">
                            <input v-model="searchQuery" type="text" placeholder="Filtra prodotti..."
                                class="w-full pl-14 pr-5 py-5 rounded-3xl bg-white border border-slate-100 font-bold outline-none focus:ring-2 focus:ring-indigo-100 shadow-sm text-lg">
                            <i data-lucide="search" class="absolute left-6 top-1/2 -translate-y-1/2 text-slate-300"></i>
                        </div>

                        <div class="space-y-3">
                            <div v-for="i in filteredInventory" :key="i.barcode" @click="generateProductPDF(i.barcode)"
                                class="card-base flex items-center justify-between hover:border-indigo-400 cursor-pointer">
                                <div class="flex-1 pr-4">
                                    <h4 class="font-bold text-slate-800 text-lg leading-tight">{{ i.name }}</h4>
                                    <p class="text-[10px] font-black text-slate-400 uppercase mt-1">{{ i.barcode }} •
                                        Confezione da {{ i.unitsPerBox }} PZ</p>
                                </div>
                                <div class="text-right">
                                    <p
                                        :class="['text-2xl font-black font-mono', i.quantity >= 0 ? 'text-indigo-600' : 'text-rose-600']">
                                        {{ i.quantity }}</p>
                                    <p class="text-[8px] font-bold text-slate-300 uppercase">Totale Pezzi</p>
                                </div>
                            </div>
                            <div v-if="!filteredInventory.length"
                                class="text-center py-20 text-slate-200 italic font-black text-2xl uppercase tracking-[0.2em]">
                                Magazzino Vuoto</div>
                        </div>
                    </div>

                    <!-- REPORTS MENU -->
                    <div v-if="currentView === 'reports_menu'" class="space-y-8 pt-4">
                        <header>
                            <button @click="currentView = 'dashboard'"
                                class="p-3 bg-white rounded-2xl shadow-sm border border-slate-100 mb-6"><i
                                    data-lucide="arrow-left" class="w-5 h-5 text-slate-500"></i></button>
                            <h1 class="text-3xl font-black text-slate-900">Reportistica</h1>
                            <p class="text-slate-400 font-bold text-xs uppercase">Generazione Documenti PDF</p>
                        </header>

                        <!-- Daily Reports Category -->
                        <div class="space-y-4">
                            <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-widest pl-2">Report per
                                Giorno</h3>
                            <div class="space-y-3 bg-white rounded-3xl p-6 border border-slate-100">
                                <div v-for="date in availableDates" :key="date"
                                    class="flex items-center justify-between pb-4 border-b border-slate-50 last:border-0 last:pb-0 pt-4 first:pt-0">
                                    <span class="font-black text-slate-700">{{ date }}</span>
                                    <div class="flex gap-2">
                                        <button @click="generateDailyReport(date, 'carico')"
                                            class="bg-emerald-100 text-emerald-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest active:scale-90">Carichi</button>
                                        <button @click="generateDailyReport(date, 'scarico')"
                                            class="bg-rose-100 text-rose-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest active:scale-90">Scarichi</button>
                                    </div>
                                </div>
                                <div v-if="!availableDates.length" class="text-center py-4 text-slate-300 italic">Nessun
                                    dato disponibile</div>
                            </div>
                        </div>

                        <!-- Product Specific Category -->
                        <div class="space-y-4 pt-6">
                            <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-widest pl-2">Scheda
                                Articolo</h3>
                            <div class="grid grid-cols-1 gap-2">
                                <div v-for="p in registeredProducts" :key="p.barcode"
                                    @click="generateProductPDF(p.barcode)"
                                    class="card-base flex items-center justify-between p-4 cursor-pointer hover:bg-slate-50">
                                    <span class="font-bold text-slate-800 text-sm">{{ p.name }}</span>
                                    <span class="text-[9px] font-black text-slate-400 uppercase">{{ p.barcode }}</span>
                                </div>
                                <div v-if="!registeredProducts.length" class="text-center py-8 text-slate-300 italic">
                                    Nessun prodotto registrato</div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- NEW PRODUCT MODAL -->
                <div v-if="showRegistryModal" class="fixed inset-0 z-[100] flex items-center justify-center p-6">
                    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="cancelRegistry"></div>
                    <div class="bg-white rounded-[2.5rem] w-full max-w-sm relative z-10 p-10 shadow-2xl">
                        <div class="text-center space-y-4">
                            <i data-lucide="package-plus" class="w-16 h-16 text-indigo-500 mx-auto"></i>
                            <h3 class="text-xl font-black">Nuovo Prodotto</h3>
                            <p class="text-slate-400 font-bold text-[10px] uppercase">Barcode: {{ newItemBarcode }}</p>
                        </div>
                        <div class="space-y-5 mt-8">
                            <div>
                                <label class="text-[10px] font-black text-slate-300 uppercase block mb-1">Nome
                                    Articolo</label>
                                <input v-model="regName" id="regNameInput" type="text"
                                    class="w-full px-5 py-4 bg-slate-50 rounded-2xl outline-none font-bold focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-300 uppercase block mb-1">Pezzi per
                                    Confezione</label>
                                <input v-model.number="regUnits" type="number"
                                    class="w-full px-5 py-4 bg-slate-50 rounded-2xl outline-none font-black focus:ring-2 focus:ring-indigo-500 text-xl">
                            </div>
                            <div class="flex gap-4 pt-4">
                                <button @click="cancelRegistry"
                                    class="flex-1 font-black text-slate-300 uppercase text-xs">Annulla</button>
                                <button @click="saveRegistry"
                                    class="flex-[2] bg-slate-900 text-white py-4 rounded-2xl font-black uppercase text-xs tracking-widest">Salva</button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <script type="module">
        // GLOBAL ERROR HANDLER
        window.onerror = (m, u, l) => {
            console.error(m, l);
            if (window.appRef) window.appRef.fatalError = `Errore alla riga ${l}: ${m}`;
        };

        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        const app = createApp({
            setup() {
                const fatalError = ref(null);
                const currentView = ref('dashboard');
                const isOnline = ref(navigator.onLine);
                const sessions = ref([]);
                const productRegistry = ref({});
                const activeSessionId = ref(null);

                const newItemBarcode = ref('');
                const newItemQty = ref(null);
                const searchQuery = ref('');
                const qtyInput = ref(null);

                const showRegistryModal = ref(false);
                const regName = ref('');
                const regUnits = ref(1);

                const showScanner = ref(false);
                let scannerInstance = null;

                // --- DATA PERSISTENCE ---
                const saveState = () => {
                    localStorage.setItem('cm_enterprise_v3_sessions', JSON.stringify(sessions.value));
                    localStorage.setItem('cm_enterprise_v3_registry', JSON.stringify(productRegistry.value));
                };

                onMounted(() => {
                    window.appRef = this;
                    const s = localStorage.getItem('cm_enterprise_v3_sessions');
                    const r = localStorage.getItem('cm_enterprise_v3_registry');
                    if (s) sessions.value = JSON.parse(s);
                    if (r) productRegistry.value = JSON.parse(r);

                    window.addEventListener('online', () => isOnline.value = true);
                    window.addEventListener('offline', () => isOnline.value = false);
                    nextTick(() => lucide.createIcons());
                });

                watch([sessions, productRegistry], saveState, { deep: true });
                watch(currentView, () => nextTick(() => lucide.createIcons()));

                // --- COMPUTED ---
                const activeSession = computed(() => sessions.value.find(s => s.id === activeSessionId.value) || { items: [] });
                const sortedItems = computed(() => [...(activeSession.value.items || [])].reverse());
                const newItemData = computed(() => productRegistry.value[newItemBarcode.value]);

                const sortedSessions = computed(() => [...sessions.value].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)));

                const inventory = computed(() => {
                    const map = new Map();
                    sessions.value.filter(s => s.status === 'closed').forEach(sess => {
                        (sess.items || []).forEach(item => {
                            const b = item.barcode;
                            const prod = productRegistry.value[b] || { name: 'Sconosciuto', unitsPerBox: 1 };
                            const curr = map.get(b) || { barcode: b, name: prod.name, unitsPerBox: prod.unitsPerBox, quantity: 0 };
                            const impact = item.quantity * prod.unitsPerBox;
                            curr.quantity += (sess.type === 'carico' ? impact : -impact);
                            map.set(b, curr);
                        });
                    });
                    return Array.from(map.values()).sort((a, b) => b.quantity - a.quantity);
                });

                const filteredInventory = computed(() => {
                    if (!searchQuery.value) return inventory.value;
                    const q = searchQuery.value.toLowerCase();
                    return inventory.value.filter(i => i.name.toLowerCase().includes(q) || i.barcode.includes(q));
                });

                const availableDates = computed(() => {
                    const dates = new Set();
                    sessions.value.forEach(s => dates.add(new Date(s.createdAt).toLocaleDateString()));
                    return Array.from(dates).sort((a, b) => new Date(b) - new Date(a));
                });

                const registeredProducts = computed(() => {
                    return Object.keys(productRegistry.value).map(k => ({ barcode: k, ...productRegistry.value[k] }))
                        .sort((a, b) => a.name.localeCompare(b.name));
                });

                // --- NAVIGATION & SESSIONS ---
                const startSession = (type) => {
                    const label = type === 'carico' ? 'Entrata Merce' : 'Uscita Merce';
                    const name = prompt(`Identificativo sessione (${label}):`, `${label} - ${new Date().toLocaleDateString()}`);
                    if (!name) return;
                    const id = 'S-' + Date.now() + Math.random().toString(36).slice(2, 5);
                    sessions.value.push({
                        id, type, name, status: 'open', items: [],
                        createdAt: new Date().toISOString()
                    });
                    activeSessionId.value = id;
                    currentView.value = 'session';
                };

                const openSession = (id) => { activeSessionId.value = id; currentView.value = 'session'; };

                const closeScannerAndBack = () => { stopScanner(); currentView.value = 'dashboard'; };

                // --- PRODUCT HANDLING ---
                const handleBarcodeEntry = () => {
                    if (!newItemBarcode.value) return;
                    if (newItemData.value) { nextTick(() => qtyInput.value?.focus()); }
                    else { showRegistryModal.value = true; nextTick(() => document.getElementById('regNameInput')?.focus()); }
                };

                const saveRegistry = () => {
                    if (!regName.value || !regUnits.value) return;
                    productRegistry.value[newItemBarcode.value] = {
                        name: regName.value.trim(),
                        unitsPerBox: parseInt(regUnits.value) || 1
                    };
                    showRegistryModal.value = false;
                    nextTick(() => qtyInput.value?.focus());
                };

                const cancelRegistry = () => { showRegistryModal.value = false; newItemBarcode.value = ''; };

                const addItem = () => {
                    if (!newItemBarcode.value || !newItemQty.value) return;
                    activeSession.value.items.push({
                        barcode: newItemBarcode.value,
                        productName: newItemData.value.name,
                        unitsPerBox: newItemData.value.unitsPerBox,
                        quantity: parseInt(newItemQty.value)
                    });
                    newItemBarcode.value = ''; newItemQty.value = null;
                    nextTick(() => document.querySelector('input[placeholder*="Scansiona"]')?.focus());
                };

                const removeItem = (i) => {
                    activeSession.value.items.splice(activeSession.value.items.length - 1 - i, 1);
                };

                const closeActiveSession = () => {
                    if (!confirm("Sei sicuro di voler chiudere la sessione?")) return;
                    activeSession.value.status = 'closed';
                    currentView.value = 'dashboard';
                };

                // --- SCANNER ---
                const toggleScanner = () => {
                    if (showScanner.value) { stopScanner(); }
                    else {
                        showScanner.value = true;
                        nextTick(() => {
                            scannerInstance = new Html5Qrcode("reader");
                            scannerInstance.start({ facingMode: "environment" }, { fps: 12, qrbox: 250 }, (txt) => {
                                newItemBarcode.value = txt; stopScanner(); handleBarcodeEntry();
                            }, () => { });
                        });
                    }
                };

                const stopScanner = () => {
                    if (scannerInstance) { scannerInstance.stop().finally(() => { showScanner.value = false; scannerInstance = null; }); }
                    else { showScanner.value = false; }
                };

                // --- PDF GENERATION (FIXED & ADVANCED) ---
                const generatePDF = (title, headers, rows, filename) => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // Header Style
                    doc.setFillColor(30, 41, 59); // Slate 800
                    doc.rect(0, 0, 210, 40, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(22);
                    doc.setFont("helvetica", "bold");
                    doc.text("REPORT MAGAZZINO", 15, 20);
                    doc.setFontSize(10);
                    doc.text(title.toUpperCase(), 15, 30);

                    // Table
                    doc.autoTable({
                        startY: 50,
                        head: [headers],
                        body: rows,
                        theme: 'grid',
                        headStyles: { fillColor: [79, 70, 229], textColor: [255, 255, 255], fontStyle: 'bold' },
                        styles: { fontSize: 9, cellPadding: 4 },
                        margin: { left: 15, right: 15 }
                    });

                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`Generato il ${new Date().toLocaleString('it-IT')}`, 15, doc.internal.pageSize.getHeight() - 10);

                    doc.save(filename || `Report_${Date.now()}.pdf`);
                };

                const generateInventoryPDF = () => {
                    const rows = inventory.value.map(i => [i.barcode, i.name, i.unitsPerBox, i.quantity]);
                    generatePDF("Giacenza Generale Magazzino", ["Barcode", "Descrizione", "Pezzi/Conf", "Totale Pezzi"], rows, "Giacenza_Generale.pdf");
                };

                const generateSessionPDF = (session) => {
                    const rows = session.items.map(i => [i.barcode, i.productName, i.quantity, i.unitsPerBox, i.quantity * i.unitsPerBox]);
                    generatePDF(`Sessione: ${session.name}`, ["Barcode", "Articolo", "Colli", "PZ/C", "Tot Pezzi"], rows, `Sessione_${session.id}.pdf`);
                };

                const generateDailyReport = (date, type) => {
                    const daySessions = sessions.value.filter(s => new Date(s.createdAt).toLocaleDateString() === date && s.type === type && s.status === 'closed');
                    const itemsMap = new Map();
                    daySessions.forEach(s => s.items.forEach(i => {
                        const existing = itemsMap.get(i.barcode) || { name: i.productName, qty: 0, pz: 0 };
                        existing.qty += i.quantity;
                        existing.pz += (i.quantity * i.unitsPerBox);
                        itemsMap.set(i.barcode, existing);
                    }));

                    const rows = Array.from(itemsMap.entries()).map(([code, d]) => [code, d.name, d.qty, d.pz]);
                    generatePDF(`Report Giornaliero ${type.toUpperCase()} - ${date}`, ["Barcode", "Articolo", "Tot Colli", "Tot Pezzi"], rows, `Report_${type}_${date.replace(/\//g, '-')}.pdf`);
                };

                const generateProductPDF = (barcode) => {
                    const prod = productRegistry.value[barcode];
                    const history = [];
                    sessions.value.filter(s => s.status === 'closed').forEach(s => {
                        s.items.filter(i => i.barcode === barcode).forEach(i => {
                            history.push([
                                new Date(s.createdAt).toLocaleDateString(),
                                s.type.toUpperCase(),
                                s.name,
                                s.type === 'carico' ? `+${i.quantity}` : `-${i.quantity}`,
                                i.quantity * i.unitsPerBox
                            ]);
                        });
                    });

                    const currentStock = inventory.value.find(i => i.barcode === barcode)?.quantity || 0;
                    generatePDF(`Scheda Prodotto: ${prod.name} (Giacenza: ${currentStock} PZ)`, ["Data", "Tipo", "Sessione", "Colli", "Pezzi"], history, `Scheda_${prod.name}.pdf`);
                };

                return {
                    fatalError, currentView, isOnline, newItemBarcode, newItemQty, searchQuery, qtyInput, showScanner,
                    showRegistryModal, regName, regUnits, sessions, activeSessionId, activeSession, sortedItems, filteredInventory,
                    newItemData, availableDates, registeredProducts, sortedSessions,
                    startSession, openSession, handleBarcodeEntry, saveRegistry, cancelRegistry, addItem, removeItem, closeActiveSession,
                    formatDate: (d) => d ? new Date(d).toLocaleString('it-IT') : '',
                    formatDateShort: (d) => d ? new Date(d).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' }) : '',
                    closeScannerAndBack, toggleScanner, stopScanner,
                    generateInventoryPDF, generateSessionPDF, generateDailyReport, generateProductPDF
                };
            }
        });

        app.mount('#app');
    </script>
</body>

</html>
